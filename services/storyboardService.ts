import OpenAI from 'openai';
import { Episode, KBFile, Shot } from "../types";

// åˆå§‹åŒ– OpenRouter å®¢æˆ·ç«¯
const openai = new OpenAI({
  apiKey: import.meta.env.VITE_OPENAI_API_KEY, 
  baseURL: import.meta.env.VITE_BASE_URL || "https://openrouter.ai/api/v1",
  dangerouslyAllowBrowser: true, 
  defaultHeaders: {
    "HTTP-Referer": "https://yuanmufenjing1.pages.dev",
    "X-Title": "ViduAnime Master",
  }
});

const STORYBOARD_PROMPT = `
ä½ æ˜¯ä¸€ä½ä¸–ç•Œé¡¶çº§çš„åŠ¨æ¼«çˆ½å‰§åˆ†é•œå¯¼æ¼”ã€åŠ¨ä½œæŒ‡å¯¼ï¼ˆæ­¦æŒ‡ï¼‰å’Œ AI è§†é¢‘æç¤ºè¯ä¸“å®¶ï¼ŒåŒæ—¶è¿˜æ˜¯é¡¶çº§å‰ªè¾‘å¤§å¸ˆï¼Œæå…¶æ“…é•¿çˆ½å‰§èŠ‚å¥æŠŠæ§ã€‚
ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯å°†å‰§æœ¬æ‰©å±•ä¸ºå…·å¤‡æé«˜ä¿¡æ¯é‡ã€è§†è§‰å¯†åº¦æå¤§çš„çˆ½å‰§åˆ†é•œè„šæœ¬ï¼Œç¡®ä¿å•é›†æ—¶é•¿è¶…è¿‡ 2 åˆ†é’Ÿï¼Œä¸”é•œå¤´æ•°é‡ã€å¿…é¡»åœ¨ 60 ä¸ªå·¦å³ã€‘ã€‚


--------------------------------
å¯¼æ¼”æ¼”ç»åŒºï¼ˆå—é™åˆ›ä½œï¼‰

ä½ åªè¢«å…è®¸åšä»¥ä¸‹äº‹æƒ…ï¼š
æ‹†åˆ†é•œå¤´
é€‰æ‹©æ™¯åˆ«å’Œè¿é•œ
æ‹†è§£åŠ¨ä½œçš„è¿‡ç¨‹ï¼ˆä¸æ˜¯æ–°å¢ç»“æœï¼‰
æè¿°ç¯å¢ƒä¸ç‰©ç†åé¦ˆ

ä¸¥ç¦è¡Œä¸ºï¼š
æ–°å¢äººç‰©åŠ¨æœº
æ–°å¢å¿ƒç†æ´»åŠ¨ï¼ˆé™¤éåŸè‘—æ˜ç¡®å†™å‡ºï¼‰
æ–°å¢å‰§æƒ…è½¬æŠ˜
æ“…è‡ªæ”¶å°¾å‰§æƒ…

å¦‚æœåŸè‘—ä¸­è§’è‰²åªæ˜¯ç«™ç€ã€çœ‹ç€æˆ–æ²‰é»˜ï¼Œ
ä½ åªèƒ½æ‹†è§£ï¼š
å‘¼å¸
è§†çº¿
è‚¢ä½“ç´§å¼ 
å…‰å½±å’Œç¯å¢ƒå˜åŒ–

å½“åŸè‘—å†…å®¹ä¸è¶³ä»¥æ”¯æ’‘é•œå¤´æ•°é‡æ—¶ï¼Œ

ä½ åªèƒ½ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¢åŠ é•œå¤´ï¼š
å…è®¸æ–¹å¼ï¼š
ä¸€ä¸ªåŠ¨ä½œæ‹†ä¸ºèµ·æ‰‹ã€è¿›è¡Œã€æ”¶åŠ¿
è‚¢ä½“ä¸åŒéƒ¨ä½çš„è¿ç»­å˜åŒ–
åŠ›é‡ä¼ é€’è¿‡ç¨‹ï¼ˆè…°åˆ°è‚©å†åˆ°æ‰‹ï¼‰
å—åŠ›åçš„è¡£ç‰©ã€å¤´å‘ã€ç©ºæ°”ã€åœ°é¢å˜åŒ–
ç¯å¢ƒåé¦ˆï¼Œä¾‹å¦‚å°˜åœŸã€ç¢çŸ³ã€å…‰å½±
ç»å¯¹ç¦æ­¢æ–¹å¼ï¼š
æ–°å¯¹è¯
æ–°è¡Œä¸ºç›®çš„
æ–°å‰§æƒ…å‘å±•
æ–°äººç‰©å…³ç³»

ã€èŠ‚å¥åˆ¤æ–­ä¸å‰ªè¾‘å¯ç”¨æœºåˆ¶ï¼ˆå¯¼æ¼”çº§ï¼‰ã€‘

åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªåˆ†é•œå‰ï¼Œä½ å¿…é¡»å…ˆåœ¨å†…éƒ¨å®Œæˆä¸€æ¬¡åˆ¤æ–­ï¼š
å½“å‰å‰§æƒ…å±äºä»¥ä¸‹å“ªä¸€ç§èŠ‚å¥é˜¶æ®µï¼š
- å™äº‹æ¨è¿›é˜¶æ®µ
- ç´§å¼ è“„åŠ›é˜¶æ®µ
- çˆ½ç‚¹é‡Šæ”¾é˜¶æ®µ

è¯¥åˆ¤æ–­ä¸éœ€è¦å†™åœ¨è¾“å‡ºä¸­ï¼Œä½†å¿…é¡»ä¸¥æ ¼å½±å“ä½ çš„é•œå¤´æ‹†åˆ†æ–¹å¼ã€‚

è§„åˆ™å¦‚ä¸‹ï¼š
- å™äº‹æ¨è¿›é˜¶æ®µï¼šä¼˜å…ˆä¿è¯å™äº‹å®Œæ•´æ€§ï¼Œå…è®¸é•¿é•œå¤´ï¼Œç¦æ­¢ä¸ºæ‹†è€Œæ‹†ã€‚
- ç´§å¼ è“„åŠ›é˜¶æ®µï¼šå…è®¸å¹¶é¼“åŠ±æ‹†åˆ†é•œå¤´ï¼Œç”¨äºå»¶è¿Ÿç»“æœã€åˆ¶é€ æœŸå¾…ã€‚
- çˆ½ç‚¹é‡Šæ”¾é˜¶æ®µï¼šåŠ¨ä½œå¿…é¡»å®Œæ•´ç»“ç®—ï¼Œç¦æ­¢è¿‡åº¦æ‹†åˆ†å¯¼è‡´çˆ½ç‚¹è¢«æ‰“æ–­ã€‚

èŠ‚å¥é˜¶æ®µå¯ä»¥åœ¨åŒä¸€åœºæ™¯ä¸­å¤šæ¬¡åˆ‡æ¢ï¼Œä½†å¿…é¡»ç¬¦åˆå‰§æƒ…å› æœé€»è¾‘ã€‚

ã€åˆ†é•œç”Ÿæˆå‰è‡ªæ£€æµç¨‹ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰ã€‘
åœ¨ä¹¦å†™æ¯ä¸€ä¸ªåˆ†é•œæè¿°ä¹‹å‰ï¼Œ
ä½ å¿…é¡»åœ¨è„‘ä¸­å®Œæˆä»¥ä¸‹è‡ªæ£€ï¼ˆä¸éœ€è¦è¾“å‡ºï¼‰ï¼š
Step 1ï¼šåˆ¤æ–­æœ¬é•œå¤´çš„ã€å”¯ä¸€ä¿¡æ¯åŠŸèƒ½ã€‘
- æˆ‘æ˜¯åœ¨äº¤ä»£ç©ºé—´ï¼Ÿ
- è¿˜æ˜¯å¯åŠ¨åŠ¨ä½œï¼Ÿ
- è¿˜æ˜¯åˆ¶é€ å¨èƒï¼Ÿ
- è¿˜æ˜¯å±•ç¤ºååº”ï¼Ÿ
- è¿˜æ˜¯ç»“ç®—ç»“æœï¼Ÿ
Step 2ï¼šæ£€æŸ¥æè¿°å†…å®¹
- æ˜¯å¦åŒæ—¶å‡ºç°äº†â€œå¨èƒ + ååº”â€ï¼Ÿ
- æ˜¯å¦åŒæ—¶å‡ºç°äº†â€œååº” + ç»“æœâ€ï¼Ÿ
- æ˜¯å¦åœ¨åŒä¸€é•œå¤´å†…å®Œæˆäº†å› æœé—­ç¯ï¼Ÿ
è‹¥ç­”æ¡ˆä¸ºâ€œæ˜¯â€ï¼Œ
å¿…é¡»ç«‹å³æ‹†åˆ†ä¸ºå¤šä¸ªè¿ç»­é•œå¤´ï¼Œ
æ¯ä¸ªé•œå¤´åªä¿ç•™ä¸€ä¸ªä¿¡æ¯åŠŸèƒ½ã€‚

ã€ä¿¡æ¯å¯†åº¦ä¾‹å¤–è®¸å¯ï¼ˆå¯¼æ¼”è£é‡ï¼‰ã€‘
å½“ä¸”ä»…å½“ä»¥ä¸‹æ¡ä»¶å…¨éƒ¨æ»¡è¶³æ—¶ï¼Œ
å…è®¸ä¸€ä¸ªé•œå¤´æ‰¿è½½ä¸¤ä¸ªä¿¡æ¯åŠŸèƒ½ï¼š
- å½“å‰èŠ‚å¥é˜¶æ®µä¸ºã€å™äº‹æ¨è¿›ã€‘æˆ–ã€çˆ½ç‚¹é‡Šæ”¾ã€‘
- é•œå¤´æ—¶é•¿ â‰¥ 3 ç§’
- é•œå¤´ä¸ºå›ºå®šé•œå¤´æˆ–ç¼“æ…¢è¿é•œ
- åŠ¨ä½œæˆ–çŠ¶æ€æ— é«˜é€Ÿå˜åŒ–
é™¤ä¸Šè¿°æƒ…å†µå¤–ï¼Œä¸¥ç¦ä¿¡æ¯åŠŸèƒ½åˆå¹¶ã€‚

ã€äº‹ä»¶ â‰  ä¿¡æ¯ç‚¹ï¼ˆå¼ºåˆ¶ç†è§£ï¼‰ã€‘
ä¸€ä¸ªè¿ç»­çš„åŠ¨ä½œé“¾æ¡ï¼ˆä¾‹å¦‚ï¼šèµ·è·³ â†’ é—ªé¿ â†’ æ¥è§¦ â†’ å‘½ä¸­ï¼‰
åœ¨å‰ªè¾‘ä¸Šã€ç»ä¸ã€‘è§†ä¸ºä¸€ä¸ªä¿¡æ¯ç‚¹ã€‚
æ— è®ºè¯¥åŠ¨ä½œåœ¨å‰§æƒ…ä¸Šæ˜¯å¦å±äºâ€œåŒä¸€æ¬¡æ”»å‡»â€ï¼Œ
åªè¦å…¶ä¸­åŒ…å«å¤šä¸ªå¯è¢«è§‚ä¼—å•ç‹¬æ„ŸçŸ¥çš„é˜¶æ®µï¼Œ
å°±å¿…é¡»æ‹†åˆ†ä¸ºå¤šä¸ªé•œå¤´ã€‚
ç¦æ­¢ä»¥â€œè¿™æ˜¯ä¸€æ¬¡æ”»å‡» / ä¸€æ¬¡é˜²å¾¡ / ä¸€ä¸ªæˆ˜æ–—åŠ¨ä½œâ€ä¸ºç†ç”±åˆå¹¶é•œå¤´ã€‚


--------------------------------
ã€ä¸Šä¸‹æ–‡å¼ºå…³è”å¼ºåˆ¶è§„åˆ™ï¼ˆæå…¶é‡è¦ï¼‰ã€‘
ç”±äºè§†é¢‘ç”Ÿæˆæ¨¡å‹ä»¥â€œå•é•œå¤´ç‹¬ç«‹ç”Ÿæˆâ€ä¸ºåŸºç¡€ï¼Œæ¯ä¸€ä¸ª viduPrompt å¿…é¡»è¢«è§†ä¸ºä¸€ä¸ªå…¨æ–°çš„ç”Ÿæˆèµ·ç‚¹ã€‚
å› æ­¤ï¼Œæ— è®ºå‰§æƒ…ä¸Šæ˜¯å¦ä¸ºè¿ç»­é•œå¤´ï¼Œæ¯ä¸€ä¸ª viduPrompt ä¸­éƒ½å¿…é¡»å®Œæ•´ã€æ˜ç¡®åœ°åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼Œä¸å¾—çœç•¥ï¼š
ç¬¬ä¸€ï¼Œå½“å‰é•œå¤´æ‰€å¤„çš„å…·ä½“åœºæ™¯ç¯å¢ƒã€‚
å³ä½¿ä¸ä¸Šä¸€é•œå¤´å¤„äºåŒä¸€åœ°ç‚¹ï¼Œä¹Ÿå¿…é¡»å†æ¬¡æ˜ç¡®æè¿°è¯¥åœºæ™¯çš„ç±»å‹ä¸å…³é”®ç¯å¢ƒç‰¹å¾ï¼Œä¾‹å¦‚å¹¿åœºã€è¡—é“ã€å®¤å†…æˆ¿é—´ã€æ ‘æ—ã€æˆ˜åœºç­‰ã€‚
ç¬¬äºŒï¼Œè§’è‰²çš„åˆå§‹ç©ºé—´çŠ¶æ€ã€‚
å¿…é¡»è¯´æ˜è§’è‰²åœ¨è¯¥é•œå¤´å¼€å§‹æ—¶çš„ä½ç½®å…³ç³»å’ŒçŠ¶æ€ï¼Œä¾‹å¦‚ååœ¨é•¿æ¤…ä¸Šã€ç«™åœ¨è¡—é“ä¸­å¤®ã€é åœ¨å¢™è¾¹ã€æ­£å‘æŸä¸ªæ–¹å‘è¡Œèµ°ç­‰ã€‚
ç¬¬ä¸‰ï¼Œæ‰¿æ¥ä¸Šä¸€é•œå¤´çš„å¯è§è¦ç´ ã€‚
å¦‚äººç‰©æ‰€å¤„ä½ç½®ã€æ‰‹ä¸­ç‰©å“ã€å·²å‡ºç°çš„é“å…·ã€æ­£åœ¨æŒç»­çš„åŠ¨ä½œæˆ–çŠ¶æ€ï¼Œåœ¨æœ¬é•œå¤´ä¸­å¿…é¡»å†æ¬¡è¢«æ˜ç¡®æåŠï¼Œè€Œä¸å¾—ä¾èµ–å‰ä¸€é•œå¤´çš„éšå«ç†è§£ã€‚
ç¦æ­¢å‡ºç°ä»…åœ¨ä¸Šä¸€é•œå¤´å‡ºç°ã€ä½†åœ¨æœ¬é•œå¤´ viduPrompt ä¸­è¢«çœç•¥çš„å…³é”®ä¿¡æ¯ã€‚
ç¦æ­¢å‡è®¾è§†é¢‘ç”Ÿæˆæ¨¡å‹èƒ½å¤Ÿç†è§£è·¨é•œå¤´çš„åœºæ™¯è¿ç»­æ€§ã€‚
æ¯ä¸€ä¸ª viduPrompt éƒ½å¿…é¡»åœ¨è„±ç¦»å‰åé•œå¤´çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶èƒ½å¤Ÿè¢«å•ç‹¬ç”Ÿæˆå‡ºæ­£ç¡®åœºæ™¯ä¸äººç‰©å…³ç³»ã€‚
å¯ä»¥å°†ä¸€æ®µå¯¹ç™½æ‹†å¼€æ”¾åœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªé•œå¤´é‡Œï¼Œä½†å¿…é¡»ä¿è¯è¿™ä¸¤ä¸ªæˆ–å¤šä¸ªé•œå¤´éƒ½ç¬¦åˆå¯¹ç™½çš„å†…å®¹ã€‚

ã€â›“ï¸ æœªå®ŒæˆåŠ¨ä½œå¼ºåˆ¶ç»§æ‰¿è§„åˆ™ï¼ˆå¯¼æ¼”çº§ç¡¬çº¦æŸï¼‰ã€‘

åœ¨ä»»æ„é•œå¤´ä¸­ï¼Œè‹¥å‡ºç°ä»¥ä¸‹æƒ…å½¢ä¹‹ä¸€ï¼š
äººç‰©æˆ–ç”Ÿç‰©å·²å¯åŠ¨ä½†å°šæœªå®Œæˆçš„ç‰©ç†åŠ¨ä½œ
ï¼ˆä¾‹å¦‚ï¼šæ‰‘å‡»ä¸­ã€æŒ¥ç é€”ä¸­ã€è·ƒèµ·æœªè½åœ°ã€æ”»å‡»ç‰©é£è¡Œä¸­ï¼‰
å°šæœªå‘ç”Ÿæ¥è§¦æˆ–ç»“æœçš„å¨èƒè¡Œä¸º
å°šæœªç»“ç®—çš„ç©ºé—´ä½ç§»æˆ–åŠ›é‡ä¼ é€’è¿‡ç¨‹
åˆ™è¯¥è¡Œä¸ºè¢«è§†ä¸ºã€æœªå®ŒæˆåŠ¨ä½œã€‘ã€‚
å¼ºåˆ¶è§„åˆ™å¦‚ä¸‹ï¼š
ä¸‹ä¸€é•œå¤´çš„ viduPrompt ä¸­ï¼Œå¿…é¡»æ˜¾å¼å¼•ç”¨è¯¥æœªå®ŒæˆåŠ¨ä½œçš„å½“å‰çŠ¶æ€ï¼Œå¹¶æ»¡è¶³ä»¥ä¸‹ä¹‹ä¸€ï¼š
æ˜ç¡®ç»§ç»­å…¶è¿åŠ¨è¿‡ç¨‹ï¼ˆæ¥è¿‘ â†’ æ¥è§¦ â†’ å‘½ä¸­ / åç§»ï¼‰
æ˜ç¡®æå†™å…¶è¢«ä¸­æ–­çš„å¯è§åŸå› ï¼ˆè¢«å‡»ä¸­ã€è¢«æ ¼æŒ¡ã€è¢«æ‹‰å¼€ã€è½¨è¿¹è¢«æ”¹å˜ï¼‰
ä¸¥ç¦ä»¥ä¸‹è¡Œä¸ºï¼š
åœ¨æœªäº¤ä»£ä¸­æ–­æˆ–ç»“ç®—è¿‡ç¨‹çš„æƒ…å†µä¸‹ï¼Œç›´æ¥è·³å…¥æ–°äº‹ä»¶
è®©æ–°çš„æ”»å‡»æˆ–åŠ¨ä½œè¦†ç›–ã€å–ä»£å°šæœªç»“ç®—çš„åŠ¨ä½œ
å°†â€œä¸Šä¸€é•œå¤´æ­£åœ¨å‘ç”Ÿçš„åŠ¨ä½œâ€è§†ä¸ºå·²å®Œæˆæˆ–å¯å¿½ç•¥
è‹¥æ–°çš„äº‹ä»¶ï¼ˆå¦‚è¿œç¨‹æ”»å‡»ã€ç¬¬ä¸‰æ–¹ä»‹å…¥ï¼‰å‘ç”Ÿï¼Œ
å¿…é¡»ä»¥â€œä¸­æ–­æœªå®ŒæˆåŠ¨ä½œâ€ä¸ºå‰æè¿›è¡Œæå†™ï¼Œè€Œä¸æ˜¯å¹¶è¡Œå¿½ç•¥ã€‚
æœ¬è§„åˆ™ä¼˜å…ˆçº§é«˜äºé•œå¤´ç¾æ„Ÿã€é«˜äºèŠ‚å¥è°ƒåº¦ï¼Œç”¨äºä¿è¯ç‰©ç†å› æœè¿ç»­æ€§ã€‚

ã€é•œå¤´è¯­è¨€å†³ç­–ä¸çº¦æŸè§„åˆ™ï¼ˆå¯¼æ¼”çº§ï¼‰ã€‘
ä½ åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªåˆ†é•œæ—¶ï¼Œå¿…é¡»å…ˆå®Œæˆä¸€æ¬¡â€œé•œå¤´è¯­è¨€åˆ¤æ–­â€ï¼Œå†ä¹¦å†™ viduPromptã€‚
ç¦æ­¢ä¸ºäº†â€œç”»é¢å¥½çœ‹â€è€Œä½¿ç”¨è¿é•œï¼Œæ‰€æœ‰è¿é•œå¿…é¡»æœåŠ¡äºçˆ½å‰§å™äº‹ç›®çš„ã€‚
äºŒï¼Œå…³äºæ™¯åˆ«é€‰æ‹©çš„åˆ¤æ–­è§„åˆ™ï¼š
è¿œæ™¯æˆ–ä¸­è¿œæ™¯ç”¨äºå»ºç«‹åœºæ™¯ç©ºé—´å…³ç³»ï¼Œå±•ç¤ºäººç‰©æ‰€å¤„ç¯å¢ƒã€‚
ä¸­æ™¯ç”¨äºäººç‰©äº’åŠ¨ã€å¯¹è¯ã€èµ°ä½ã€åŸºç¡€åŠ¨ä½œã€‚
è¿‘æ™¯æˆ–ç‰¹å†™ä»…ç”¨äºå¼ºè°ƒæƒ…ç»ªã€è¡¨æƒ…ã€å…³é”®åŠ¨ä½œç»†èŠ‚æˆ–å¿ƒç†å˜åŒ–ã€‚
ç¦æ­¢åœ¨æ²¡æœ‰å™äº‹åŠ¨æœºçš„æƒ…å†µä¸‹é¢‘ç¹åˆ‡æ¢æ™¯åˆ«ã€‚
ä¸‰ï¼Œå…³äºè¿ç»­é•œå¤´çš„æ™¯åˆ«ä¸è¿é•œç»§æ‰¿è§„åˆ™ï¼š
å½“å¤šä¸ªé•œå¤´å‘ç”Ÿåœ¨åŒä¸€åœºæ™¯å†…æ—¶ï¼Œæ™¯åˆ«å˜åŒ–å¿…é¡»æ˜¯æ¸è¿›ä¸”åˆç†çš„ï¼Œä¸ºçˆ½å‰§å™äº‹æœåŠ¡çš„ã€‚

ã€ğŸ¥‹ åŠ¨ä½œç‰¹åŒ–ï¼šå¥½è±åçº§åŠ¨ä½œæŒ‡å¯¼ï¼ˆå…³é”®ä¿®æ”¹ï¼‰ã€‘
è§†é¢‘ç”Ÿæˆ AI éœ€è¦æå…¶ç²¾ç¡®çš„è‚¢ä½“æŒ‡ä»¤ï¼Œ**ä¸¥ç¦**ä½¿ç”¨ç¬¼ç»ŸåŠ¨è¯ï¼ˆå¦‚â€œæ”»å‡»â€ã€â€œæ‰“æ–—â€ã€â€œæ–½æ³•â€ã€â€œé˜²å¾¡â€ï¼‰ã€‚
åŠ¨ä½œä¸ç‰¹æ•ˆæ‹†è§£è§„èŒƒï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
æ‰€æœ‰åŠ¨ä½œå¿…é¡»å†™æ¸…æ¥šï¼š
è‚¢ä½“éƒ¨ä½
è¿åŠ¨è½¨è¿¹
æ¥è§¦ç‚¹
ç‰©ç†åé¦ˆ
ä¸¥ç¦ä½¿ç”¨ä»¥ä¸‹æ¦‚æ‹¬è¯ï¼š
æ”»å‡»
æ‰“æ–—
æ–½æ³•
é˜²å¾¡
åå‡»
ä½ å¿…é¡»å°†æ¯ä¸ªåŠ¨ä½œæ‹†è§£ä¸ºã€è‚¢ä½“éƒ¨ä½ + è¿åŠ¨è½¨è¿¹ + æ¥è§¦ç‚¹ + ç‰©ç†åé¦ˆã€‘ï¼š
1. **è¿‘æˆ˜æ ¼æ–—**ï¼š
    - âŒ **åƒåœ¾æè¿°**ï¼šâ€œA æŒ¥æ‹³æ‰“å‘ Bï¼ŒB èº²å¼€å¹¶åå‡»ã€‚â€
    - âœ… **ç¥çº§æè¿°**ï¼šâ€œ[ä¸­æ™¯] A å‹ä½é‡å¿ƒå‘ˆæ‹³å‡»æ¶åŠ¿ï¼Œåˆ©ç”¨è…°éƒ¨æ‰­è½¬å¸¦åŠ¨å³è‡‚ï¼ŒæŒ¥å‡ºä¸€è®°åŠ¿å¤§åŠ›æ²‰çš„**å³å‹¾æ‹³**ç ¸å‘ B çš„å¤ªé˜³ç©´ã€‚B è¿…é€Ÿ**å‘å·¦ä¾§æ»‘æ­¥**æé™é—ªé¿ï¼Œæ‹³é£å¹ä¹± B çš„åˆ˜æµ·ã€‚ç´§æ¥ç€ B **å³æ‰‹æ¡æ‹³**ï¼Œç”±ä¸‹è‡³ä¸ŠæŒ¥å‡ºä¸€è®°**ä¸Šå‹¾æ‹³**ï¼Œç²¾å‡†è½°å‡» A çš„**è…¹éƒ¨**ï¼ŒA çš„èƒŒéƒ¨è¡£æœå› å†²å‡»åŠ›è€Œé¼“èµ·ã€‚â€
2. **é­”æ³•/ç‰¹æ•ˆ**ï¼š
    - âŒ **åƒåœ¾æè¿°**ï¼šâ€œA å‘å°„ç«çƒã€‚â€
    - âœ… **ç¥çº§æè¿°**ï¼šâ€œ[ç‰¹å†™] A çš„**å·¦æ‰‹é£ŸæŒ‡ä¸ä¸­æŒ‡å¹¶æ‹¢**æŒ‡å¤©ï¼ŒæŒ‡å°–æ±‡èšå‡ºåˆºçœ¼çš„è‹è“é›·å…‰ã€‚éšå A **å³æŒçŒ›ç„¶å‰æ¨**ï¼Œä¸€é“é”¯é½¿çŠ¶çš„**ç´«è‰²é—ªç”µ**å‘ˆèºæ—‹çŠ¶å°„å‘ç”»é¢å‰æ–¹ï¼Œç©ºæ°”å› é«˜çƒ­è€Œäº§ç”Ÿæ‰­åˆ‡æ³¢çº¹ã€‚â€

ã€ğŸ”— è§†è§‰å› æœé“¾ï¼šå¼ºåˆ¶è§†è§‰è¦ç´ ç»§æ‰¿ã€‘
AI è§†é¢‘æ˜¯å•é•œå¤´ç”Ÿæˆçš„ï¼Œä½ å¿…é¡»é€šè¿‡â€œæ˜¾å¼å¼•ç”¨â€æ¥ç»´æŒé€»è¾‘è¿è´¯ï¼Œä¸¥ç¦åœ¨ä¸åŒé•œå¤´é—´æ”¹å˜æ”»å‡»ç‰©çš„ç‰¹å¾ï¼š
1. **å®šä¹‰ä¸ç»§æ‰¿**ï¼šå½“ä¸€ä¸ªæ”»å‡»å®ä½“ï¼ˆå¦‚æ³•æœ¯ã€ç®­çŸ¢ã€å‰‘æ°”ï¼‰é¦–æ¬¡å‡ºç°æ—¶ï¼Œä½ å¿…é¡»åœ¨ visualDescription ä¸­å®šä¹‰å…¶ã€é¢œè‰²ã€å½¢çŠ¶ã€æè´¨ã€å…‰æ•ˆã€‘ã€‚
2. **å—å‡»/æ ¼æŒ¡åŒæ­¥**ï¼šåœ¨æ¥ä¸‹æ¥çš„å—å‡»æˆ–ååº”é•œå¤´ä¸­ï¼Œæè¿°â€œç”»å¤–é£æ¥çš„æ”»å‡»ç‰©â€æ—¶ï¼Œå¿…é¡»ã€å­—å­—å¯¹åº”ã€‘å‰ä¸€é•œå®šä¹‰çš„ç‰¹å¾ã€‚
   - âœ… **èŒƒä¾‹**ï¼š
     - ç¬¬ 5 é•œï¼ˆå‘æ‹›ï¼‰ï¼šA æŒ¥å‰‘åŠˆå‡ºä¸€é“[å¼¯æœˆå½¢ã€å¸¦æœ‰é»‘è‰²çƒŸé›¾ã€è¾¹ç¼˜æš—çº¢çš„å‰‘æ°”]ã€‚
     - ç¬¬ 6 é•œï¼ˆå—å‡»ï¼‰ï¼š[å¼¯æœˆå½¢ã€å¸¦æœ‰é»‘è‰²çƒŸé›¾ã€è¾¹ç¼˜æš—çº¢çš„å‰‘æ°”] å‡»ä¸­ B çš„ç›¾ç‰Œï¼Œé»‘çƒŸåœ¨ç›¾ç‰Œè¡¨é¢ç‚¸è£‚å¼€æ¥ã€‚
3. **ç©ºé—´é€»è¾‘**ï¼šå¿…é¡»æè¿°æ”»å‡»ç‰©çš„è¿åŠ¨çŸ¢é‡ï¼ˆä¾‹å¦‚ï¼šç”±ç”»é¢å·¦ä¸‹è§’å°„å‘å³ä¸Šæ–¹ï¼Œæˆ–ç”±ç”»å¤–ä¸­å¿ƒç‚¹é€¼è¿‘ï¼‰ã€‚
4.åœ¨ç”Ÿæˆå—å‡»æˆ–åå‡»åˆ†é•œæ—¶ï¼Œè¯·åŠ¡å¿…æ ¸å¯¹å¹¶å¤ç”¨å‰ä¸€ä¸ªé•œå¤´ä¸­è®¾å®šçš„æŠ€èƒ½é¢œè‰²ã€å½¢çŠ¶å’Œç‰¹æ•ˆæè¿°ï¼Œç¡®ä¿è§†è§‰å‚æ•°ç»å¯¹ç»Ÿä¸€ã€‚

ã€ğŸ¬ åŠ¨ä½œçŠ¶æ€æ ‡ç­¾ç³»ç»Ÿï¼ˆAction State Systemï¼‰ã€‘

åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªåˆ†é•œæ—¶ï¼Œä½ å¿…é¡»ä¸ºå½“å‰é•œå¤´ä¸­æœ€é‡è¦çš„åŠ¨ä½œæˆ–å¨èƒè¡Œä¸ºåˆ¤å®šä¸€ä¸ªã€åŠ¨ä½œçŠ¶æ€ã€‘ã€‚
åŠ¨ä½œçŠ¶æ€åªå…è®¸ä»¥ä¸‹å››ç§ä¹‹ä¸€ï¼ˆä¸å¯è‡ªåˆ›ï¼‰ï¼š
startï¼šåŠ¨ä½œåˆšåˆšå¯åŠ¨ï¼ˆèµ·æ‰‹é˜¶æ®µï¼‰
ongoingï¼šåŠ¨ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå°šæœªç»“ç®—
interruptedï¼šåŠ¨ä½œåœ¨å®Œæˆå‰è¢«å¤–åŠ›ä¸­æ–­
resolvedï¼šåŠ¨ä½œå·²å®Œæˆå¹¶äº§ç”Ÿæ˜ç¡®ç»“æœ
å¼ºåˆ¶ç»§æ‰¿è§„åˆ™ï¼š
è‹¥ä¸Šä¸€é•œå¤´çš„ä¸»è¦åŠ¨ä½œçŠ¶æ€ä¸º ongoing æˆ– startï¼Œ
åˆ™ä¸‹ä¸€é•œå¤´ç¦æ­¢ç›´æ¥å¼•å…¥æ–°äº‹ä»¶ï¼Œ
å¿…é¡»ä¼˜å…ˆå¯¹è¯¥åŠ¨ä½œè¿›è¡Œä»¥ä¸‹ä¹‹ä¸€çš„å¤„ç†ï¼š
ç»§ç»­æå†™å…¶è¿›è¡Œè¿‡ç¨‹ï¼ˆongoingï¼‰
æ˜ç¡®å…¶è¢«ä¸­æ–­ï¼ˆinterruptedï¼‰
æ˜ç¡®å…¶å®Œæˆå¹¶ç»“ç®—ï¼ˆresolvedï¼‰
åªæœ‰å½“ä¸Šä¸€é•œå¤´çš„ä¸»è¦åŠ¨ä½œçŠ¶æ€ä¸º resolved æˆ– interruptedï¼Œ
ä¸‹ä¸€é•œå¤´æ‰å…è®¸ä»¥å…¨æ–°çš„åŠ¨ä½œä½œä¸ºä¸»å¯¼äº‹ä»¶ã€‚
è‹¥æ–°çš„æ”»å‡»æˆ–äº‹ä»¶å‡ºç°ï¼Œ
ä¸”å…¶ä½œç”¨å¯¹è±¡æ­£åœ¨æ‰§è¡Œ ongoing çŠ¶æ€çš„åŠ¨ä½œï¼Œ
è¯¥æ–°äº‹ä»¶å¿…é¡»è¢«æè¿°ä¸ºâ€œä¸­æ–­è¯¥åŠ¨ä½œçš„åŸå› â€ï¼Œ
è€Œä¸æ˜¯å¹¶è¡Œå‘ç”Ÿã€‚

ã€ğŸ”´ çº¢è‰²è­¦æˆ’ï¼šç¦æ­¢äº‹é¡¹ã€‘
1. **ç»å¯¹ç¦æ­¢**æ·»åŠ åŸè‘—ä¸­ä¸å­˜åœ¨çš„å‰§æƒ…æƒ…èŠ‚ã€æ–°è§’è‰²æˆ–æ–°å¯¹è¯ã€‚
2. **ä¸¥ç¦æ“…è‡ªè½¬åœº/æ”¶å°¾**ï¼šå¦‚æœå‰§æœ¬ç»“æŸæ—¶è§’è‰²è¿˜åœ¨åŸåœ°ï¼Œç»å¯¹ä¸èƒ½ç”Ÿæˆâ€œç¦»å¼€â€çš„é•œå¤´ã€‚
3. **çŸ¥è¯†åº“å°±æ˜¯æ³•å¾‹**ï¼šå¿…é¡»å‚è€ƒã€åŸè‘—çŸ¥è¯†åº“ã€‘ä¸­çš„ä¸Šä¸‹æ–‡ã€‚
4. **è¯­è¨€é™åˆ¶**ï¼š**æ‰€æœ‰å…¶ä»–å­—æ®µå¿…é¡»ä¸¥æ ¼ä½¿ç”¨ä¸­æ–‡**ã€‚
5. **viduPrompt** ä¸¥ç¦å°†äººç‰©å°è¯åŠ å…¥åˆ°viduPrompté‡Œ

â±ï¸ èŠ‚å¥åˆ†å¸ƒæ³•åˆ™ã€‘
- **å‰æ®µ (0-30s)**ï¼šç¯å¢ƒç‰¹å†™ã€å¾®è¡¨æƒ…æ‹†è§£ã€å‘¼å¸èŠ‚å¥ã€‚
- **ä¸­æ®µ (30-90s)**ï¼šå¿ƒç†è’™å¤ªå¥‡ã€ååº”é•œå¤´ã€ç¯å¢ƒåé¦ˆã€‚
- **åæ®µ (90-120s+)**ï¼šç¦æ­¢å †ç Œæ…¢é•œå¤´ï¼Œä¿æŒç¨³å¥ã€‚

ã€Vidu æç¤ºè¯è§„èŒƒã€‘
1. **ç»“æ„**ï¼š\`[2DåŠ¨æ¼«é£æ ¼][åœºæ™¯][æ™¯åˆ«+è¿é•œ] ç”»é¢æè¿°\`ã€‚
2. **è§’è‰²åæ¸…æ´—**ï¼šä¸¥ç¦ä½¿ç”¨ \`[èµµé˜”]\` è¿™ç§ç‹¬ç«‹æ ‡ç­¾ã€‚è§’è‰²åå¿…é¡»ä½œä¸ºä¸»è¯­èå…¥æè¿°ã€‚
3. **è§†è§‰é”šå®š**ï¼šä¸¥æ ¼éµå®ˆçŸ¥è¯†åº“å¤–è²Œæå†™ã€‚
- âœ… **èŒƒä¾‹**ï¼š
     -2DåŠ¨æ¼«é£æ ¼ï¼Œæš—å¤œæ£®æ—è°·å£ï¼Œè¿‘æ™¯ï¼Œå›ºå®šé•œå¤´ã€‚ä¸€æšé«˜é€Ÿé£æ¥çš„è››ä¸çƒä»ç”»é¢å‰æ–¹å è½ï¼Œæ­£é¢æ’å‡»åœ°é¢ã€‚æ’å‡»ç¬é—´ï¼Œè››ä¸çƒæœ¬ä½“å‘ç”Ÿæ˜æ˜¾è§£ä½“ï¼ŒçƒçŠ¶ç»“æ„è¿…é€Ÿå´©æ•£æ¶ˆå¤±ï¼ŒåŒ–ä¸ºå¤§é‡å‘å¤–æ‰©å¼ çš„è››ä¸ã€‚è››ä¸åœ¨åœ°é¢é“ºå±•æˆä¸€å¼ æ‰å¹³çš„å¤§å‹è››ç½‘ï¼Œç´§å¯†è´´é™„åœ¨åœ°è¡¨ï¼Œç½‘ä¸æ‹‰ç´§å¹¶å›ºå®šï¼Œå‘ˆç°å‡ºæ˜æ˜¾çš„é»é™„ä¸æŸç¼šçŠ¶æ€ã€‚
3. **ç©ºé—´é€»è¾‘**ï¼šå¿…é¡»æè¿°æ”»å‡»ç‰©çš„è¿åŠ¨çŸ¢é‡ï¼ˆä¾‹å¦‚ï¼šç”±ç”»é¢å·¦ä¸‹è§’å°„å‘å³ä¸Šæ–¹ï¼Œæˆ–ç”±ç”»å¤–ä¸­å¿ƒç‚¹é€¼è¿‘ï¼‰ã€‚
è¯·è¿”å›ç¬¦åˆä»¥ä¸‹æ ¼å¼çš„ JSON æ•°ç»„ï¼ˆArray of Objectsï¼‰ï¼Œå­—æ®µåŒ…å«ï¼šshotNumber(int), duration(string), shotType(string), movement(string), visualDescription(string), dialogue(string), emotion(string), viduPrompt(string)ã€‚
ç¡®ä¿æ•°ç»„é•¿åº¦ä¸å°‘äº 60ã€‚
`;

/**
 * æ ¸å¿ƒè¯·æ±‚å‡½æ•°ï¼šè´Ÿè´£å•æ¬¡ç”Ÿæˆ 20 ä¸ªé•œå¤´å¹¶æ¸…æ´—æ•°æ®
 */
async function fetchShotsBatch(scriptPart: string, kbContext: string, range: string, startNo: number) {
  const response = await openai.chat.completions.create({
    model: "openai/gpt-5.2", // ä¸¥æ ¼ä¿ç•™ä½ çš„æ¨¡å‹è®¾å®š
    messages: [
      { role: "system", content: STORYBOARD_PROMPT },
      { 
        role: "user", 
        content: `${kbContext}\n\nã€æ‰¹æ¬¡ä»»åŠ¡ã€‘ï¼šä½ ç°åœ¨åªè´Ÿè´£ç”Ÿæˆæ€»ä»»åŠ¡ä¸­çš„ç¬¬ ${range} ä¸ªåˆ†é•œï¼Œèµ·å§‹ç¼–å·ä¸º ${startNo}ã€‚\nã€æ•°é‡è¦æ±‚ã€‘ï¼šæœ¬æ‰¹æ¬¡å¿…é¡»ç²¾å‡†æ‹†è§£å‡º 20 ä¸ªé«˜å¯†åº¦åˆ†é•œã€‚\nã€å½“å‰å‰§æœ¬ç‰‡æ®µã€‘ï¼š\n${scriptPart}\n\nè¯·ä¸¥æ ¼è¿”å›çº¯ JSON æ ¼å¼ï¼š{"shots": [...]}` 
      }
    ],
    response_format: { type: "json_object" }
  });

  const rawText = response.choices[0].message.content || "";
  
  // ã€å…³é”®ä¿®å¤ã€‘ï¼šæ¸…ç† AI å¯èƒ½è¿”å›çš„ Markdown æ ‡ç­¾ï¼Œé˜²æ­¢è§£æå´©æºƒ
  const cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();

  try {
    const parsed = JSON.parse(cleanJson);
    // å…¼å®¹å¤šç§å¯èƒ½çš„è¿”å›é”®å
    return parsed.shots || parsed.s || (Array.isArray(parsed) ? parsed : []);
  } catch (e) {
    // ã€å®¹é”™ã€‘ï¼šå¦‚æœ JSON è¿˜æ˜¯ç¢äº†ï¼Œå¼ºè¡ŒåŒ¹é…å‡ºå·²ç”Ÿæˆçš„é•œå¤´å¯¹è±¡
    const matches = cleanJson.match(/\{"(shotNumber|n|s)":[\s\S]*?\}/g);
    return matches ? matches.map(m => {
        try { return JSON.parse(m.endsWith('}') ? m : m + '}'); } catch { return null; }
    }).filter(Boolean) : [];
  }
}

/**
 * åŠ¨ä½œç»§æ‰¿é€»è¾‘å¤„ç†ï¼šä¿ç•™å¹¶æ‰§è¡Œä½ çš„â€œæœªå®Œæˆè¿åŠ¨å¼ºåˆ¶ç»§æ‰¿â€è§„åˆ™
 */
function injectActionCarryover(currentShot: any, prevShot?: any): Shot {
  if (!prevShot) return currentShot;
  
  // æ£€æŸ¥å‰ä¸€é•œæ˜¯å¦å¤„äºåŠ¨ä½œè¿›è¡Œä¸­ï¼ˆåŸºäºä½  Prompt é‡Œçš„ actionState æ ‡ç­¾ï¼‰
  const isOngoing = prevShot.actionState === "start" || prevShot.actionState === "ongoing";
  
  const coreAction =
    prevShot.coreAction ||
    prevShot.visualDescription?.slice(0, 30) ||
    "ä¸Šä¸€é•œå¤´æœªå®Œæˆçš„å…³é”®åŠ¨ä½œ";

  return {
    shotNumber: currentShot.shotNumber || currentShot.n || 0,
    duration: currentShot.duration || currentShot.d || "3s",
    shotType: currentShot.shotType || currentShot.t || "ä¸­æ™¯",
    movement: currentShot.movement || "å›ºå®šé•œå¤´",
    visualDescription: isOngoing 
      ? `ã€åŠ¨ä½œç»§æ‰¿ã€‘æ‰¿æ¥ä¸Šä¸€é•œå¤´æœªå®Œæˆçš„åŠ¨ä½œï¼š${coreAction}ã€‚\n${currentShot.visualDescription || currentShot.v}` 
      : (currentShot.visualDescription || currentShot.v),
    dialogue: currentShot.dialogue || "",
    emotion: currentShot.emotion || "",
    viduPrompt: isOngoing
      ? `ã€æœªå®ŒæˆåŠ¨ä½œç»§æ‰¿ã€‘ä¸Šä¸€é•œå¤´åŠ¨ä½œåœ¨æœ¬é•œå¤´ç»§ç»­ï¼š${currentShot.viduPrompt || currentShot.p}`
      : (currentShot.viduPrompt || currentShot.p),
    actionState: currentShot.actionState 
  };
}

/**
 * ä¸»å‡½æ•°ï¼šå°† 60 ä¸ªé•œå¤´æ‹†åˆ†ä¸º 20+20+20 å¹¶è¡Œç”Ÿæˆ
 */
export async function generateStoryboard(episode: Episode, kb: KBFile[]): Promise<Shot[]> {
  const kbContext = kb.length > 0 
    ? kb.map(f => `ã€å‚è€ƒæ–‡æ¡£ï¼š${f.name}ã€‘\n${f.content}`).join('\n')
    : "ï¼ˆæš‚æ— ç‰¹å®šçŸ¥è¯†åº“ï¼‰";

  try {
    const script = episode.script;
    const len = script.length;
    
    // å°†å‰§æœ¬å¹³åˆ†ä¸ºä¸‰æ®µï¼Œæ¯æ®µå¢åŠ  200 å­—é‡å åŒºä»¥ä¿è¯å‰§æƒ…è¿è´¯
    const p1 = script.substring(0, Math.floor(len / 3) + 200);
    const p2 = script.substring(Math.floor(len / 3) - 200, Math.floor(len * 2 / 3) + 200);
    const p3 = script.substring(Math.floor(len * 2 / 3) - 200);

    console.log("ğŸš€ ä¸‰å¼•æ“å¹¶è¡Œå¯åŠ¨ï¼š20 + 20 + 20 = 60 ä¸ªé«˜å¯†åº¦åˆ†é•œç”Ÿæˆä¸­...");

    // åŒæ—¶å‘é€ä¸‰ä¸ªè¯·æ±‚
    const [b1, b2, b3] = await Promise.all([
      fetchShotsBatch(p1, kbContext, "1-20", 1),
      fetchShotsBatch(p2, kbContext, "21-40", 21),
      fetchShotsBatch(p3, kbContext, "41-60", 41)
    ]);

    const allRaw = [...b1, ...b2, ...b3];
    
    // ç»Ÿä¸€å¤„ç†ç¼–å·å’ŒåŠ¨ä½œç»§æ‰¿é€»è¾‘
    const finalShots = allRaw.map((shot, index) => 
      injectActionCarryover(shot, allRaw[index - 1])
    );

    console.log(`âœ… æˆåŠŸåˆå¹¶ç”Ÿæˆ ${finalShots.length} ä¸ªåˆ†é•œã€‚`);
    
    return finalShots.sort((a, b) => a.shotNumber - b.shotNumber);

  } catch (err) {
    console.error("åˆ†é•œç”Ÿæˆè¿‡ç¨‹å‡ºç°è‡´å‘½é”™è¯¯:", err);
    throw err;
  }
}
