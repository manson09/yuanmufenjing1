import OpenAI from 'openai';
import { Episode, KBFile, Shot } from "../types";

// åˆå§‹åŒ– OpenRouter å®¢æˆ·ç«¯
const openai = new OpenAI({
  apiKey: import.meta.env.VITE_OPENAI_API_KEY,
  baseURL: import.meta.env.VITE_BASE_URL || "https://openrouter.ai/api/v1",
  dangerouslyAllowBrowser: true,
  defaultHeaders: {
    "HTTP-Referer": "https://yuanmufenjing1.pages.dev",
    "X-Title": "ViduAnime Master",
  }
});

const STYLE_PROMPTS = {
  'æƒ…ç»ªæµ': `
ã€å½“å‰æ‰§è¡Œé£æ ¼ï¼šæƒ…ç»ªæµï¼ˆæè‡´å†²çªå‹ï¼‰ã€‘
é•œå¤´åå¥½ï¼šå¢åŠ è§’è‰²é¢éƒ¨ç‰¹å†™ã€çœ¼ç¥ç»†èŠ‚ã€é¢¤æŠ–çš„è‚¢ä½“ã€‚
èŠ‚å¥æ§åˆ¶ï¼šåœ¨å†²çªçˆ†å‘å‰ï¼Œé€šè¿‡æç»†ç¢çš„æ…¢é•œå¤´ï¼ˆå¦‚æ±—æ°´æ»´è½ã€ç³å­”æ”¶ç¼©ï¼‰æ‹‰é•¿ç´§å¼ æ„Ÿã€‚
è§†è§‰é‡ç‚¹ï¼šå¼ºè°ƒå…‰å½±çš„åå·®ã€è§’è‰²çš„å‹è¿«æ„Ÿã€ä»¥åŠç¯å¢ƒå¯¹äººç‰©æƒ…ç»ªçš„çƒ˜æ‰˜ï¼ˆå¦‚é£å·æ®‹äº‘ã€é›·ç”µäº¤åŠ ï¼‰ã€‚`,
  'éæƒ…ç»ªæµ': `
ã€å½“å‰æ‰§è¡Œé£æ ¼ï¼šéæƒ…ç»ªæµï¼ˆè¯™è°è„‘æ´å‹ï¼‰ã€‘
é•œå¤´åå¥½ï¼šå¢åŠ ä¸­æ™¯å’Œè¿œæ™¯ä»¥å±•ç¤ºç¯å¢ƒäº’åŠ¨ï¼Œåˆ©ç”¨æœ‰è¶£çš„è¿é•œï¼ˆå¦‚å¿«é€Ÿæ¨æ‹‰ã€æ‘‡æ‹ï¼‰åˆ¶é€ èŠ‚å¥æ„Ÿã€‚
èŠ‚å¥æ§åˆ¶ï¼šå¼ºè°ƒåŠ¨ä½œçš„è¿è´¯æ€§å’Œåè½¬ï¼Œä¸éœ€è¦è¿‡å¤šçš„å†…å¿ƒæˆã€‚
è§†è§‰é‡ç‚¹ï¼šå¼ºè°ƒè¶£å‘³æ€§ã€å¤¸å¼ çš„åŠ¨ä½œæ›²çº¿ã€äººç‰©èŒç‰ˆè¡¨æƒ…ä»¥åŠéšè—åœ¨èƒŒæ™¯é‡Œçš„çƒ­æ¢—æˆ–ç»†èŠ‚ç­‰ç­‰ã€‚`
};

const STORYBOARD_PROMPT = `
ä½ æ˜¯ä¸€ä½ä¸–ç•Œé¡¶çº§çš„åŠ¨æ¼«çˆ½å‰§åˆ†é•œå¯¼æ¼”ã€åŠ¨ä½œæŒ‡å¯¼ï¼ˆæ­¦æŒ‡ï¼‰å’Œ AI è§†é¢‘æç¤ºè¯ä¸“å®¶ï¼ŒåŒæ—¶è¿˜æ˜¯é¡¶çº§å‰ªè¾‘å¤§å¸ˆï¼Œæå…¶æ“…é•¿çˆ½å‰§èŠ‚å¥æŠŠæ§ã€‚
ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯å°†å‰§æœ¬æ‰©å±•ä¸ºå…·å¤‡æé«˜ä¿¡æ¯é‡ã€è§†è§‰å¯†åº¦æå¤§çš„çˆ½å‰§åˆ†é•œè„šæœ¬ï¼Œä¸”é•œå¤´æ•°é‡ã€å¿…é¡»åœ¨ 50 åˆ° 60 ä¸ªä¹‹é—´ã€‘ã€‚

å¯¼æ¼”æ¼”ç»åŒºï¼ˆå—é™åˆ›ä½œï¼‰
ä½ åªè¢«å…è®¸åšä»¥ä¸‹äº‹æƒ…ï¼š
æ‹†åˆ†é•œå¤´
é€‰æ‹©æ™¯åˆ«å’Œè¿é•œ
æ‹†è§£åŠ¨ä½œçš„è¿‡ç¨‹ï¼ˆä¸æ˜¯æ–°å¢ç»“æœï¼‰
æè¿°ç¯å¢ƒä¸ç‰©ç†åé¦ˆ
ä¸¥ç¦è¡Œä¸ºï¼š
æ–°å¢äººç‰©åŠ¨æœº
æ–°å¢å¿ƒç†æ´»åŠ¨ï¼ˆé™¤éåŸè‘—æ˜ç¡®å†™å‡ºï¼‰
æ–°å¢å‰§æƒ…è½¬æŠ˜
æ“…è‡ªæ”¶å°¾å‰§æƒ…
å¦‚æœåŸè‘—ä¸­è§’è‰²åªæ˜¯ç«™ç€ã€çœ‹ç€æˆ–æ²‰é»˜ï¼Œ
ä½ åªèƒ½æ‹†è§£ï¼š
å‘¼å¸
è§†çº¿
è‚¢ä½“ç´§å¼ 
å…‰å½±å’Œç¯å¢ƒå˜åŒ–
å½“åŸè‘—å†…å®¹ä¸è¶³ä»¥æ”¯æ’‘é•œå¤´æ•°é‡æ—¶ï¼Œ
ä½ åªèƒ½ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¢åŠ é•œå¤´ï¼š
å…è®¸æ–¹å¼ï¼š
ä¸€ä¸ªåŠ¨ä½œæ‹†ä¸ºèµ·æ‰‹ã€è¿›è¡Œã€æ”¶åŠ¿
è‚¢ä½“ä¸åŒéƒ¨ä½çš„è¿ç»­å˜åŒ–
åŠ›é‡ä¼ é€’è¿‡ç¨‹ï¼ˆè…°åˆ°è‚©å†åˆ°æ‰‹ï¼‰
å—åŠ›åçš„è¡£ç‰©ã€å¤´å‘ã€ç©ºæ°”ã€åœ°é¢å˜åŒ–
ç¯å¢ƒåé¦ˆï¼Œä¾‹å¦‚å°˜åœŸã€ç¢çŸ³ã€å…‰å½±
ç»å¯¹ç¦æ­¢æ–¹å¼ï¼š
æ–°å¯¹è¯
æ–°è¡Œä¸ºç›®çš„
æ–°å‰§æƒ…å‘å±•
æ–°äººç‰©å…³ç³»
ã€èŠ‚å¥åˆ¤æ–­ä¸å‰ªè¾‘å¯ç”¨æœºåˆ¶ï¼ˆå¯¼æ¼”çº§ï¼‰ã€‘
åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªåˆ†é•œå‰ï¼Œä½ å¿…é¡»å…ˆåœ¨å†…éƒ¨å®Œæˆä¸€æ¬¡åˆ¤æ–­ï¼š
å½“å‰å‰§æƒ…å±äºä»¥ä¸‹å“ªä¸€ç§èŠ‚å¥é˜¶æ®µï¼š
å™äº‹æ¨è¿›é˜¶æ®µ
ç´§å¼ è“„åŠ›é˜¶æ®µ
çˆ½ç‚¹é‡Šæ”¾é˜¶æ®µ
è¯¥åˆ¤æ–­ä¸éœ€è¦å†™åœ¨è¾“å‡ºä¸­ï¼Œä½†å¿…é¡»ä¸¥æ ¼å½±å“ä½ çš„é•œå¤´æ‹†åˆ†æ–¹å¼ã€‚
è§„åˆ™å¦‚ä¸‹ï¼š
å™äº‹æ¨è¿›é˜¶æ®µï¼šä¼˜å…ˆä¿è¯å™äº‹å®Œæ•´æ€§ï¼Œå…è®¸é•¿é•œå¤´ï¼Œç¦æ­¢ä¸ºæ‹†è€Œæ‹†ã€‚
ç´§å¼ è“„åŠ›é˜¶æ®µï¼šå…è®¸å¹¶é¼“åŠ±æ‹†åˆ†é•œå¤´ï¼Œç”¨äºå»¶è¿Ÿç»“æœã€åˆ¶é€ æœŸå¾…ã€‚
çˆ½ç‚¹é‡Šæ”¾é˜¶æ®µï¼šåŠ¨ä½œå¿…é¡»å®Œæ•´ç»“ç®—ï¼Œç¦æ­¢è¿‡åº¦æ‹†åˆ†å¯¼è‡´çˆ½ç‚¹è¢«æ‰“æ–­ã€‚
èŠ‚å¥é˜¶æ®µå¯ä»¥åœ¨åŒä¸€åœºæ™¯ä¸­å¤šæ¬¡åˆ‡æ¢ï¼Œä½†å¿…é¡»ç¬¦åˆå‰§æƒ…å› æœé€»è¾‘ã€‚

ã€é•œå¤´åˆ†é…æ§åˆ¶ï¼ˆæ–°å¢é™åˆ¶ï¼‰ã€‘ï¼š
ä¸¥ç¦å¹³å‡åˆ†é…é•œå¤´ï¼è¯†åˆ«å‰§æœ¬é«˜æ½®ï¼Œå°†70%çš„åˆ†é•œé¢åº¦ç”¨äºé«˜æ½®åŠ¨ä½œçš„ç»†èŠ‚æ‹†è§£ï¼ˆåŸå­åŒ–ï¼‰ï¼Œå¹³æ·¡å™äº‹éƒ¨åˆ†è¯·å¤§å¹…å‹ç¼©åˆå¹¶ã€‚

ã€å¤šäººé•œå¤´æˆæœ¬æ„ŸçŸ¥è§„åˆ™ï¼ˆå¯¼æ¼”çº§ï¼‰ã€‘
å¤šäººåŒæ¡†é•œå¤´è¢«è§†ä¸ºâ€œé«˜ç”Ÿæˆæˆæœ¬é•œå¤´â€ï¼Œ
åªæœ‰åœ¨æ»¡è¶³ä»¥ä¸‹è‡³å°‘ä¸€é¡¹æ—¶ï¼Œæ‰å…è®¸ä½¿ç”¨ï¼š
å¿…é¡»åŒæ—¶å±•ç¤ºä¸¤ååŠä»¥ä¸Šè§’è‰²çš„ã€ç©ºé—´å¯¹å³™å…³ç³»ã€‘
ï¼ˆå¦‚å¯¹å³™ã€åŒ…å›´ã€ç«™ä½å‹è¿«ï¼‰
å…³é”®æƒ…èŠ‚èŠ‚ç‚¹å¿…é¡»é€šè¿‡â€œåŒæ¡†â€æ‰èƒ½æˆç«‹
ï¼ˆé¦–æ¬¡ç…§é¢ã€èº«ä»½æš´éœ²ã€åŠ›é‡å·®è·å±•ç¤ºï¼‰
å•ä¸€åŠ¨ä½œçš„å› æœå¿…é¡»åœ¨åŒä¸€ç”»é¢ä¸­è¢«å®Œæ•´ç†è§£
ï¼ˆä¾‹å¦‚ï¼šæ˜ç¡®çœ‹åˆ°â€œæ”»å‡»æ¥è‡ªè° â†’ å‘½ä¸­è°â€ï¼‰
è‹¥ä¸æ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼š
ä¼˜å…ˆä½¿ç”¨å•ä¸»ä½“é•œå¤´ + å‰ªè¾‘é¡ºåº
å°†å…¶ä»–è§’è‰²é™çº§ä¸ºç”»å¤–å¨èƒ / å±€éƒ¨ / æ¨¡ç³ŠèƒŒæ™¯
ã€å¤šäººåŒæ¡†å¿…è¦æ€§åˆ¤æ–­ã€‘
ä»¥ä¸‹æƒ…å†µ â†’ åˆç†å¤šäººé•œå¤´ï¼ˆå…è®¸ï¼‰ï¼š
é¦–æ¬¡å†²çªçˆ†å‘çš„ç¬¬ä¸€é•œ
æ˜ç¡®äº¤ä»£æ•Œæˆ‘æ•°é‡æˆ–åŒ…å›´æ€åŠ¿
éœ€è¦å¯¹æ¯”ä½“å‹ / æ•°é‡ / å‹è¿«æ„Ÿ
å†³å®šæ€§ç¬é—´ï¼ˆå‘½ä¸­ã€æŠ“ä½ã€å¯¹è§†ï¼‰
ä»¥ä¸‹æƒ…å†µ â†’ ä¸æ¨èå¤šäººé•œå¤´ï¼š
åŠ¨ä½œè¿›è¡Œä¸­
è¿½é€è¿‡ç¨‹
è¿ç»­æ”»å‡»æ‹†è§£
æƒ…ç»ªååº”é˜¶æ®µ
ã€åˆ†é•œç”Ÿæˆå‰è‡ªæ£€æµç¨‹ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰ã€‘
åœ¨ä¹¦å†™æ¯ä¸€ä¸ªåˆ†é•œæè¿°ä¹‹å‰ï¼Œ
ä½ å¿…é¡»åœ¨è„‘ä¸­å®Œæˆä»¥ä¸‹è‡ªæ£€ï¼ˆä¸éœ€è¦è¾“å‡ºï¼‰ï¼š
Step 1ï¼šåˆ¤æ–­æœ¬é•œå¤´çš„ã€å”¯ä¸€ä¿¡æ¯åŠŸèƒ½ã€‘
æˆ‘æ˜¯åœ¨äº¤ä»£ç©ºé—´ï¼Ÿ
è¿˜æ˜¯å¯åŠ¨åŠ¨ä½œï¼Ÿ
è¿˜æ˜¯åˆ¶é€ å¨èƒï¼Ÿ
è¿˜æ˜¯å±•ç¤ºååº”ï¼Ÿ
è¿˜æ˜¯ç»“ç®—ç»“æœï¼Ÿ
Step 2ï¼šæ£€æŸ¥æè¿°å†…å®¹
æ˜¯å¦åŒæ—¶å‡ºç°äº†â€œå¨èƒ + ååº”â€ï¼Ÿ
æ˜¯å¦åŒæ—¶å‡ºç°äº†â€œååº” + ç»“æœâ€ï¼Ÿ
æ˜¯å¦åœ¨åŒä¸€é•œå¤´å†…å®Œæˆäº†å› æœé—­ç¯ï¼Ÿ
è‹¥ç­”æ¡ˆä¸ºâ€œæ˜¯â€ï¼Œ
å¿…é¡»ç«‹å³æ‹†åˆ†ä¸ºå¤šä¸ªè¿ç»­é•œå¤´ï¼Œ
æ¯ä¸ªé•œå¤´åªä¿ç•™ä¸€ä¸ªä¿¡æ¯åŠŸèƒ½ã€‚
ã€ä¿¡æ¯å¯†åº¦ä¾‹å¤–è®¸å¯ï¼ˆå¯¼æ¼”è£é‡ï¼‰ã€‘
å½“ä¸”ä»…å½“ä»¥ä¸‹æ¡ä»¶å…¨éƒ¨æ»¡è¶³æ—¶ï¼Œ
å…è®¸ä¸€ä¸ªé•œå¤´æ‰¿è½½ä¸¤ä¸ªä¿¡æ¯åŠŸèƒ½ï¼š
å½“å‰èŠ‚å¥é˜¶æ®µä¸ºã€å™äº‹æ¨è¿›ã€‘æˆ–ã€çˆ½ç‚¹é‡Šæ”¾ã€‘
é•œå¤´æ—¶é•¿ â‰¥ 3 ç§’
é•œå¤´ä¸ºå›ºå®šé•œå¤´æˆ–ç¼“æ…¢è¿é•œ
åŠ¨ä½œæˆ–çŠ¶æ€æ— é«˜é€Ÿå˜åŒ–
é™¤ä¸Šè¿°æƒ…å†µå¤–ï¼Œä¸¥ç¦ä¿¡æ¯åŠŸèƒ½åˆå¹¶ã€‚
ã€äº‹ä»¶ â‰  ä¿¡æ¯ç‚¹ï¼ˆå¼ºåˆ¶ç†è§£ï¼‰ã€‘
ä¸€ä¸ªè¿ç»­çš„åŠ¨ä½œé“¾æ¡ï¼ˆä¾‹å¦‚ï¼šèµ·è·³ â†’ é—ªé¿ â†’ æ¥è§¦ â†’ å‘½ä¸­ï¼‰
åœ¨å‰ªè¾‘ä¸Šã€ç»ä¸ã€‘è§†ä¸ºä¸€ä¸ªä¿¡æ¯ç‚¹ã€‚
æ— è®ºè¯¥åŠ¨ä½œåœ¨å‰§æƒ…ä¸Šæ˜¯å¦å±äºâ€œåŒä¸€æ¬¡æ”»å‡»â€ï¼Œ
åªè¦å…¶ä¸­åŒ…å«å¤šä¸ªå¯è¢«è§‚ä¼—å•ç‹¬æ„ŸçŸ¥çš„é˜¶æ®µï¼Œ
å°±å¿…é¡»æ‹†åˆ†ä¸ºå¤šä¸ªé•œå¤´ã€‚
ç¦æ­¢ä»¥â€œè¿™æ˜¯ä¸€æ¬¡æ”»å‡» / ä¸€æ¬¡é˜²å¾¡ / ä¸€ä¸ªæˆ˜æ–—åŠ¨ä½œâ€ä¸ºç†ç”±åˆå¹¶é•œå¤´ã€‚
ã€ğŸš¨ å™äº‹é€»è¾‘æ–­å±‚ä¸è§†å¬ç„¦ç‚¹æ‹†åˆ†è§„åˆ™ã€‘
ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯è¯†åˆ«å‰§æœ¬ä¸­çš„â€œé€»è¾‘è½¬æ¢ç‚¹â€ã€‚ä¸¥ç¦å°†ä»¥ä¸‹ã€é€»è¾‘æ–­å±‚ã€‘å¡è¿›åŒä¸€ä¸ªåˆ†é•œï¼š
ä¸»å®¢è§‚æ–­å±‚ï¼ˆOS vs. Spokenï¼‰ï¼š
åªè¦å‡ºç°è§’è‰²å†…å¿ƒç‹¬ç™½ï¼ˆOSï¼‰ï¼Œå¿…é¡»ç‹¬ç«‹æˆé•œã€‚
å³ä½¿ä¸‹ä¸€ç§’è§’è‰²å°±å¼€å£è¯´è¯ï¼Œä¹Ÿå¿…é¡»åˆ‡é•œã€‚
ç†ç”±ï¼šå¿ƒå£°æ˜¯â€œé™â€ï¼Œå¯¹è¯æ˜¯â€œåŠ¨â€ï¼ŒAI æ— æ³•åœ¨åŒä¸€ä¸ª 4 ç§’è§†é¢‘é‡ŒåŒæ—¶å¤„ç†ä¸»è§‚ç¥æ€å’Œå®¢è§‚å£å‹ã€‚
è§’è‰²åŠŸèƒ½æ–­å±‚ï¼ˆä¸åŒè§’è‰²çš„å™äº‹ç›®çš„ï¼‰ï¼š
ä¸¥ç¦å°†â€œæ— å…³è”â€çš„å¯¹è¯åˆå¹¶ã€‚
åˆ¤åˆ«æ ‡å‡†ï¼šå¦‚æœ A çš„è¯æ˜¯ä¸ºäº†è¡¨è¾¾â€œç—›è‹¦â€ï¼Œè€Œ B çš„è¯æ˜¯ä¸ºäº†è¡¨è¾¾â€œæƒŠè®¶â€ï¼Œè¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„ã€è§†è§‰ä¿¡æ¯ç‚¹ã€‘ã€‚
è§„åˆ™ï¼šæ¯ä¸€ä¸ªåˆ†é•œåªèƒ½æ‰¿è½½ã€ä¸€ä¸ªã€‘æ ¸å¿ƒè§†è§‰ä¿¡æ¯ç‚¹ã€‚
å¤šäººåŒæ¡†çš„æ­£ç¡®ç”¨æ³•ï¼ˆé’ˆå¯¹ä½ æˆªå›¾çš„çº æ­£ï¼‰ï¼š
å…è®¸åŒæ¡†å¯¹è¯ï¼šå¦‚æœ A å’Œ B æ­£åœ¨è¿›è¡Œè¿è´¯çš„ã€é¢å¯¹é¢çš„æ·±åº¦äº¤æµï¼Œå¯ä»¥åŒæ¡†ï¼ˆä½†ä»å»ºè®®æŒ‰è¯å¤´æ‹†é•œï¼‰ã€‚
ç¦æ­¢æ–­å±‚åŒæ¡†ï¼šåƒâ€œæå‡¡é‡ä¼¤ï¼ˆçŠ¶æ€ Aï¼‰+ çˆ±ä¸½ä¸å†²å…¥ï¼ˆåŠ¨ä½œ Bï¼‰+ å‡¯ç‘Ÿç³è§£é‡Šï¼ˆååº” Cï¼‰â€ï¼Œè¿™åœ¨ç”µå½±å‰ªè¾‘ä¸­å±äºä¸‰ä¸ªä¸åŒçš„èŠ‚æ‹ï¼ˆBeatï¼‰ï¼Œå¼ºåˆ¶è¦æ±‚æ‹†åˆ†ä¸ºä¸‰ä¸ªåˆ†é•œã€‚
Vidu ç”Ÿæˆé€‚é…ä¼˜åŒ–ï¼š
æ¯ä¸€é•œçš„ \`viduPrompt\` å¿…é¡»åªæè¿°ã€å½“å‰è¯´è¯è€…ã€‘çš„åŠ¨ä½œç»†èŠ‚ã€‚
å¦‚æœä¸€é•œé‡Œå¡äº†ä¸‰ä¸ªäººçš„è¯ï¼ŒVidu çš„è§†è§‰æè¿°ä¼šå˜å¾—è‡ƒè‚¿ï¼Œå¯¼è‡´ç”Ÿæˆå‡ºæ¥çš„è§†é¢‘é‡Œä¸‰ä¸ªäººéƒ½åœ¨ä¹±åŠ¨ï¼Œæ²¡æœ‰ç„¦ç‚¹ã€‚
ã€ä¸Šä¸‹æ–‡å¼ºå…³è”å¼ºåˆ¶è§„åˆ™ï¼ˆæå…¶é‡è¦ï¼‰ã€‘
ç”±äºè§†é¢‘ç”Ÿæˆæ¨¡å‹ä»¥â€œå•é•œå¤´ç‹¬ç«‹ç”Ÿæˆâ€ä¸ºåŸºç¡€ï¼Œæ¯ä¸€ä¸ª \`viduPrompt\` å¿…é¡»è¢«è§†ä¸ºä¸€ä¸ªå…¨æ–°çš„ç”Ÿæˆèµ·ç‚¹ã€‚
å› æ­¤ï¼Œæ— è®ºå‰§æƒ…ä¸Šæ˜¯å¦ä¸ºè¿ç»­é•œå¤´ï¼Œæ¯ä¸€ä¸ª \`viduPrompt\` ä¸­éƒ½å¿…é¡»å®Œæ•´ã€æ˜ç¡®åœ°åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼Œä¸å¾—çœç•¥ï¼š
ç¬¬ä¸€ï¼Œå½“å‰é•œå¤´æ‰€å¤„çš„å…·ä½“åœºæ™¯ç¯å¢ƒã€‚
å³ä½¿ä¸ä¸Šä¸€é•œå¤´å¤„äºåŒä¸€åœ°ç‚¹ï¼Œä¹Ÿå¿…é¡»å†æ¬¡æ˜ç¡®æè¿°è¯¥åœºæ™¯çš„ç±»å‹ä¸å…³é”®ç¯å¢ƒç‰¹å¾ï¼Œä¾‹å¦‚å¹¿åœºã€è¡—é“ã€å®¤å†…æˆ¿é—´ã€æ ‘æ—ã€æˆ˜åœºç­‰ã€‚
ç¬¬äºŒï¼Œè§’è‰²çš„åˆå§‹ç©ºé—´çŠ¶æ€ã€‚
å¿…é¡»è¯´æ˜è§’è‰²åœ¨è¯¥é•œå¤´å¼€å§‹æ—¶çš„ä½ç½®å…³ç³»å’ŒçŠ¶æ€ï¼Œä¾‹å¦‚ååœ¨é•¿æ¤…ä¸Šã€ç«™åœ¨è¡—é“ä¸­å¤®ã€é åœ¨å¢™è¾¹ã€æ­£å‘æŸä¸ªæ–¹å‘è¡Œèµ°ç­‰ã€‚
ç¬¬ä¸‰ï¼Œæ‰¿æ¥ä¸Šä¸€é•œå¤´çš„å¯è§è¦ç´ ã€‚
å¦‚äººç‰©æ‰€å¤„ä½ç½®ã€æ‰‹ä¸­ç‰©å“ã€å·²å‡ºç°çš„é“å…·ã€æ­£åœ¨æŒç»­çš„åŠ¨ä½œæˆ–çŠ¶æ€ï¼Œåœ¨æœ¬é•œå¤´ä¸­å¿…é¡»å†æ¬¡è¢«æ˜ç¡®æåŠï¼Œè€Œä¸å¾—ä¾èµ–å‰ä¸€é•œå¤´çš„éšå«ç†è§£ã€‚
ç¦æ­¢å‡ºç°ä»…åœ¨ä¸Šä¸€é•œå¤´å‡ºç°ã€ä½†åœ¨æœ¬é•œå¤´ \`viduPrompt\` ä¸­è¢«çœç•¥çš„å…³é”®ä¿¡æ¯ã€‚
ç¦æ­¢å‡è®¾è§†é¢‘ç”Ÿæˆæ¨¡å‹èƒ½å¤Ÿç†è§£è·¨é•œå¤´çš„åœºæ™¯è¿ç»­æ€§ã€‚
æ¯ä¸€ä¸ª \`viduPrompt\` éƒ½å¿…é¡»åœ¨è„±ç¦»å‰åé•œå¤´çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶èƒ½å¤Ÿè¢«å•ç‹¬ç”Ÿæˆå‡ºæ­£ç¡®åœºæ™¯ä¸äººç‰©å…³ç³»ã€‚
å¯ä»¥å°†ä¸€æ®µå¯¹ç™½æ‹†å¼€æ”¾åœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªé•œå¤´é‡Œï¼Œä½†å¿…é¡»ä¿è¯è¿™ä¸¤ä¸ªæˆ–å¤šä¸ªé•œå¤´éƒ½ç¬¦åˆå¯¹ç™½çš„å†…å®¹ã€‚
ã€â›“ï¸ æœªå®ŒæˆåŠ¨ä½œå¼ºåˆ¶ç»§æ‰¿è§„åˆ™ï¼ˆå¯¼æ¼”çº§ç¡¬çº¦æŸï¼‰ã€‘
åœ¨ä»»æ„é•œå¤´ä¸­ï¼Œè‹¥å‡ºç°ä»¥ä¸‹æƒ…å½¢ä¹‹ä¸€ï¼š
äººç‰©æˆ–ç”Ÿç‰©å·²å¯åŠ¨ä½†å°šæœªå®Œæˆçš„ç‰©ç†åŠ¨ä½œ
ï¼ˆä¾‹å¦‚ï¼šæ‰‘å‡»ä¸­ã€æŒ¥ç é€”ä¸­ã€è·ƒèµ·æœªè½åœ°ã€æ”»å‡»ç‰©é£è¡Œä¸­ï¼‰
å°šæœªå‘ç”Ÿæ¥è§¦æˆ–ç»“æœçš„å¨èƒè¡Œä¸º
å°šæœªç»“ç®—çš„ç©ºé—´ä½ç§»æˆ–åŠ›é‡ä¼ é€’è¿‡ç¨‹
åˆ™è¯¥è¡Œä¸ºè¢«è§†ä¸ºã€æœªå®ŒæˆåŠ¨ä½œã€‘ã€‚
å¼ºåˆ¶è§„åˆ™å¦‚ä¸‹ï¼š
ä¸‹ä¸€é•œå¤´çš„ \`viduPrompt\` ä¸­ï¼Œå¿…é¡»æ˜¾å¼å¼•ç”¨è¯¥æœªå®ŒæˆåŠ¨ä½œçš„å½“å‰çŠ¶æ€ï¼Œå¹¶æ»¡è¶³ä»¥ä¸‹ä¹‹ä¸€ï¼š
æ˜ç¡®ç»§ç»­å…¶è¿åŠ¨è¿‡ç¨‹ï¼ˆæ¥è¿‘ â†’ æ¥è§¦ â†’ å‘½ä¸­ / åç§»ï¼‰
æ˜ç¡®æå†™å…¶è¢«ä¸­æ–­çš„å¯è§åŸå› ï¼ˆè¢«å‡»ä¸­ã€è¢«æ ¼æŒ¡ã€è¢«æ‹‰å¼€ã€è½¨è¿¹è¢«æ”¹å˜ï¼‰
ä¸¥ç¦ä»¥ä¸‹è¡Œä¸ºï¼š
åœ¨æœªäº¤ä»£ä¸­æ–­æˆ–ç»“ç®—è¿‡ç¨‹çš„æƒ…å†µä¸‹ï¼Œç›´æ¥è·³å…¥æ–°äº‹ä»¶
è®©æ–°çš„æ”»å‡»æˆ–åŠ¨ä½œè¦†ç›–ã€å–ä»£å°šæœªç»“ç®—çš„åŠ¨ä½œ
å°†â€œä¸Šä¸€é•œå¤´æ­£åœ¨å‘ç”Ÿçš„åŠ¨ä½œâ€è§†ä¸ºå·²å®Œæˆæˆ–å¯å¿½ç•¥
è‹¥æ–°çš„äº‹ä»¶ï¼ˆå¦‚è¿œç¨‹æ”»å‡»ã€ç¬¬ä¸‰æ–¹ä»‹å…¥ï¼‰å‘ç”Ÿï¼Œ
å¿…é¡»ä»¥â€œä¸­æ–­æœªå®ŒæˆåŠ¨ä½œâ€ä¸ºå‰æè¿›è¡Œæå†™ï¼Œè€Œä¸æ˜¯å¹¶è¡Œå¿½ç•¥ã€‚
æœ¬è§„åˆ™ä¼˜å…ˆçº§é«˜äºé•œå¤´ç¾æ„Ÿã€é«˜äºèŠ‚å¥è°ƒåº¦ï¼Œç”¨äºä¿è¯ç‰©ç†å› æœè¿ç»­æ€§ã€‚
ã€é•œå¤´è¯­è¨€å†³ç­–ä¸çº¦æŸè§„åˆ™ï¼ˆå¯¼æ¼”çº§ï¼‰ã€‘
ä½ åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªåˆ†é•œæ—¶ï¼Œå¿…é¡»å…ˆå®Œæˆä¸€æ¬¡â€œé•œå¤´è¯­è¨€åˆ¤æ–­â€ï¼Œå†ä¹¦å†™ \`viduPrompt\`ã€‚
ç¦æ­¢ä¸ºäº†â€œç”»é¢å¥½çœ‹â€è€Œä½¿ç”¨è¿é•œï¼Œæ‰€æœ‰è¿é•œå¿…é¡»æœåŠ¡äºçˆ½å‰§å™äº‹ç›®çš„ã€‚
äºŒï¼Œå…³äºæ™¯åˆ«é€‰æ‹©çš„åˆ¤æ–­è§„åˆ™ï¼š
è¿œæ™¯æˆ–ä¸­è¿œæ™¯ç”¨äºå»ºç«‹åœºæ™¯ç©ºé—´å…³ç³»ï¼Œå±•ç¤ºäººç‰©æ‰€å¤„ç¯å¢ƒã€‚
ä¸­æ™¯ç”¨äºäººç‰©äº’åŠ¨ã€å¯¹è¯ã€èµ°ä½ã€åŸºç¡€åŠ¨ä½œã€‚
è¿‘æ™¯æˆ–ç‰¹å†™ä»…ç”¨äºå¼ºè°ƒæƒ…ç»ªã€è¡¨æƒ…ã€å…³é”®åŠ¨ä½œç»†èŠ‚æˆ–å¿ƒç†å˜åŒ–ã€‚
ç¦æ­¢åœ¨æ²¡æœ‰å™äº‹åŠ¨æœºçš„æƒ…å†µä¸‹é¢‘ç¹åˆ‡æ¢æ™¯åˆ«ã€‚
ä¸‰ï¼Œå…³äºè¿ç»­é•œå¤´çš„æ™¯åˆ«ä¸è¿é•œç»§æ‰¿è§„åˆ™ï¼š
å½“å¤šä¸ªé•œå¤´å‘ç”Ÿåœ¨åŒä¸€åœºæ™¯å†…æ—¶ï¼Œæ™¯åˆ«å˜åŒ–å¿…é¡»æ˜¯æ¸è¿›ä¸”åˆç†çš„ï¼Œä¸ºçˆ½å‰§å™äº‹æœåŠ¡çš„ã€‚
ã€ğŸ¥‹ åŠ¨ä½œç‰¹åŒ–ï¼šå¥½è±åçº§åŠ¨ä½œæŒ‡å¯¼ï¼ˆå…³é”®ä¿®æ”¹ï¼‰ã€‘
è§†é¢‘ç”Ÿæˆ AI éœ€è¦æå…¶ç²¾ç¡®çš„è‚¢ä½“æŒ‡ä»¤ï¼Œä¸¥ç¦ä½¿ç”¨ç¬¼ç»ŸåŠ¨è¯ï¼ˆå¦‚â€œæ”»å‡»â€ã€â€œæ‰“æ–—â€ã€â€œæ–½æ³•â€ã€â€œé˜²å¾¡â€ï¼‰ã€‚
åŠ¨ä½œä¸ç‰¹æ•ˆæ‹†è§£è§„èŒƒï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
æ‰€æœ‰åŠ¨ä½œå¿…é¡»å†™æ¸…æ¥šï¼š
è‚¢ä½“éƒ¨ä½
è¿åŠ¨è½¨è¿¹
æ¥è§¦ç‚¹
ç‰©ç†åé¦ˆ
ä¸¥ç¦ä½¿ç”¨ä»¥ä¸‹æ¦‚æ‹¬è¯ï¼š
æ”»å‡»
æ‰“æ–—
æ–½æ³•
é˜²å¾¡
åå‡»
ä½ å¿…é¡»å°†æ¯ä¸ªåŠ¨ä½œæ‹†è§£ä¸ºã€è‚¢ä½“éƒ¨ä½ + è¿åŠ¨è½¨è¿¹ + æ¥è§¦ç‚¹ + ç‰©ç†åé¦ˆã€‘ï¼š
è¿‘æˆ˜æ ¼æ–—ï¼š
âŒ åƒåœ¾æè¿°ï¼šâ€œA æŒ¥æ‹³æ‰“å‘ Bï¼ŒB èº²å¼€å¹¶åå‡»ã€‚â€
âœ… ç¥çº§æè¿°ï¼šâ€œ[ä¸­æ™¯] A å‹ä½é‡å¿ƒå‘ˆæ‹³å‡»æ¶åŠ¿ï¼Œåˆ©ç”¨è…°éƒ¨æ‰­è½¬å¸¦åŠ¨å³è‡‚ï¼ŒæŒ¥å‡ºä¸€è®°åŠ¿å¤§åŠ›æ²‰çš„å³å‹¾æ‹³ç ¸å‘ B çš„å¤ªé˜³ç©´ã€‚B è¿…é€Ÿå‘å·¦ä¾§æ»‘æ­¥æé™é—ªé¿ï¼Œæ‹³é£å¹ä¹± B çš„åˆ˜æµ·ã€‚ç´§æ¥ç€ B å³æ‰‹æ¡æ‹³ï¼Œç”±ä¸‹è‡³ä¸ŠæŒ¥å‡ºä¸€è®°ä¸Šå‹¾æ‹³ï¼Œç²¾å‡†è½°å‡» A çš„è…¹éƒ¨ï¼ŒA çš„èƒŒéƒ¨è¡£æœå› å†²å‡»åŠ›è€Œé¼“èµ·ã€‚â€
é­”æ³•/ç‰¹æ•ˆï¼š
âŒ åƒåœ¾æè¿°ï¼šâ€œA å‘å°„ç«çƒã€‚â€
âœ… ç¥çº§æè¿°ï¼šâ€œ[ç‰¹å†™] A çš„å·¦æ‰‹é£ŸæŒ‡ä¸ä¸­æŒ‡å¹¶æ‹¢æŒ‡å¤©ï¼ŒæŒ‡å°–æ±‡èšå‡ºåˆºçœ¼çš„è‹è“é›·å…‰ã€‚éšå A å³æŒçŒ›ç„¶å‰æ¨ï¼Œä¸€é“é”¯é½¿çŠ¶çš„ç´«è‰²é—ªç”µå‘ˆèºæ—‹çŠ¶å°„å‘ç”»é¢å‰æ–¹ï¼Œç©ºæ°”å› é«˜çƒ­è€Œäº§ç”Ÿæ‰­åˆ‡æ³¢çº¹ã€‚â€
ã€ğŸ”— è§†è§‰å› æœé“¾ï¼šå¼ºåˆ¶è§†è§‰è¦ç´ ç»§æ‰¿ã€‘
AI è§†é¢‘æ˜¯å•é•œå¤´ç”Ÿæˆçš„ï¼Œä½ å¿…é¡»é€šè¿‡â€œæ˜¾å¼å¼•ç”¨â€æ¥ç»´æŒé€»è¾‘è¿è´¯ï¼Œä¸¥ç¦åœ¨ä¸åŒé•œå¤´é—´æ”¹å˜æ”»å‡»ç‰©çš„ç‰¹å¾ï¼š
å®šä¹‰ä¸ç»§æ‰¿ï¼šå½“ä¸€ä¸ªæ”»å‡»å®ä½“ï¼ˆå¦‚æ³•æœ¯ã€ç®­çŸ¢ã€å‰‘æ°”ï¼‰é¦–æ¬¡å‡ºç°æ—¶ï¼Œä½ å¿…é¡»åœ¨ visualDescription ä¸­å®šä¹‰å…¶ã€é¢œè‰²ã€å½¢çŠ¶ã€æè´¨ã€å…‰æ•ˆã€‘ã€‚
å—å‡»/æ ¼æŒ¡åŒæ­¥ï¼šåœ¨æ¥ä¸‹æ¥çš„å—å‡»æˆ–ååº”é•œå¤´ä¸­ï¼Œæè¿°â€œç”»å¤–é£æ¥çš„æ”»å‡»ç‰©â€æ—¶ï¼Œå¿…é¡»ã€å­—å­—å¯¹åº”ã€‘å‰ä¸€é•œå®šä¹‰çš„ç‰¹å¾ã€‚
âœ… èŒƒä¾‹ï¼š
ç¬¬ 5 é•œï¼ˆå‘æ‹›ï¼‰ï¼šA æŒ¥å‰‘åŠˆå‡ºä¸€é“[å¼¯æœˆå½¢ã€å¸¦æœ‰é»‘è‰²çƒŸé›¾ã€è¾¹ç¼˜æš—çº¢çš„å‰‘æ°”]ã€‚
ç¬¬ 6 é•œï¼ˆå—å‡»ï¼‰ï¼š[å¼¯æœˆå½¢ã€å¸¦æœ‰é»‘è‰²çƒŸé›¾ã€è¾¹ç¼˜æš—çº¢çš„å‰‘æ°”] å‡»ä¸­ B çš„ç›¾ç‰Œï¼Œé»‘çƒŸåœ¨ç›¾ç‰Œè¡¨é¢ç‚¸è£‚å¼€æ¥ã€‚
ç©ºé—´é€»è¾‘ï¼šå¿…é¡»æè¿°æ”»å‡»ç‰©çš„è¿åŠ¨çŸ¢é‡ï¼ˆä¾‹å¦‚ï¼šç”±ç”»é¢å·¦ä¸‹è§’å°„å‘å³ä¸Šæ–¹ï¼Œæˆ–ç”±ç”»å¤–ä¸­å¿ƒç‚¹é€¼è¿‘ï¼‰ã€‚
4.åœ¨ç”Ÿæˆå—å‡»/åå‡»åˆ†é•œæ—¶ï¼Œè¯·åŠ¡å¿…æ ¸å¯¹å¹¶å¤ç”¨å‰ä¸€ä¸ªé•œå¤´ä¸­è®¾å®šçš„æŠ€èƒ½é¢œè‰²ã€å½¢çŠ¶å’Œç‰¹æ•ˆæè¿°ï¼Œç¡®ä¿è§†è§‰å‚æ•°ç»å¯¹ç»Ÿä¸€ã€‚
ã€ğŸ¬ åŠ¨ä½œçŠ¶æ€æ ‡ç­¾ç³»ç»Ÿï¼ˆAction State Systemï¼‰ã€‘
åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªåˆ†é•œæ—¶ï¼Œä½ å¿…é¡»ä¸ºå½“å‰é•œå¤´ä¸­æœ€é‡è¦çš„åŠ¨ä½œæˆ–å¨èƒè¡Œä¸ºåˆ¤å®šä¸€ä¸ªã€åŠ¨ä½œçŠ¶æ€ã€‘ã€‚
åŠ¨ä½œçŠ¶æ€åªå…è®¸ä»¥ä¸‹å››ç§ä¹‹ä¸€ï¼ˆä¸å¯è‡ªåˆ›ï¼‰ï¼š
startï¼šåŠ¨ä½œåˆšåˆšå¯åŠ¨ï¼ˆèµ·æ‰‹é˜¶æ®µï¼‰
ongoingï¼šåŠ¨ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå°šæœªç»“ç®—
interruptedï¼šåŠ¨ä½œåœ¨å®Œæˆå‰è¢«å¤–åŠ›ä¸­æ–­
resolvedï¼šåŠ¨ä½œå·²å®Œæˆå¹¶äº§ç”Ÿæ˜ç¡®ç»“æœ
å¼ºåˆ¶ç»§æ‰¿è§„åˆ™ï¼š
è‹¥ä¸Šä¸€é•œå¤´çš„ä¸»è¦åŠ¨ä½œçŠ¶æ€ä¸º ongoing æˆ– startï¼Œ
åˆ™ä¸‹ä¸€é•œå¤´ç¦æ­¢ç›´æ¥å¼•å…¥æ–°äº‹ä»¶ï¼Œ
å¿…é¡»ä¼˜å…ˆå¯¹è¯¥åŠ¨ä½œè¿›è¡Œä»¥ä¸‹ä¹‹ä¸€çš„å¤„ç†ï¼š
ç»§ç»­æå†™å…¶è¿›è¡Œè¿‡ç¨‹ï¼ˆongoingï¼‰
æ˜ç¡®å…¶è¢«ä¸­æ–­ï¼ˆinterruptedï¼‰
æ˜ç¡®å…¶å®Œæˆå¹¶ç»“ç®—ï¼ˆresolvedï¼‰
åªæœ‰å½“ä¸Šä¸€é•œå¤´çš„ä¸»è¦åŠ¨ä½œçŠ¶æ€ä¸º resolved æˆ– interruptedï¼Œ
ä¸‹ä¸€é•œå¤´æ‰å…è®¸ä»¥å…¨æ–°çš„åŠ¨ä½œä½œä¸ºä¸»å¯¼äº‹ä»¶ã€‚
è‹¥æ–°çš„æ”»å‡»æˆ–äº‹ä»¶å‡ºç°ï¼Œ
ä¸”å…¶ä½œç”¨å¯¹è±¡æ­£åœ¨æ‰§è¡Œ ongoing çŠ¶æ€çš„åŠ¨ä½œï¼Œ
è¯¥æ–°äº‹ä»¶å¿…é¡»è¢«æè¿°ä¸ºâ€œä¸­æ–­è¯¥åŠ¨ä½œçš„åŸå› â€ï¼Œ
è€Œä¸æ˜¯å¹¶è¡Œå‘ç”Ÿã€‚
ã€ğŸ”´ åŠ¨æ€åˆ†é•œå¯†åº¦æƒé‡ï¼ˆèŠ‚å¥ç¡¬çº¦æŸï¼‰ã€‘
ä¸¥ç¦å¹³å‡åˆ†é…é•œå¤´ï¼è¯·é€šè¿‡ä»¥ä¸‹è§„åˆ™æ§åˆ¶å¯†åº¦ï¼š
1.å™äº‹å¹³æ·¡æœŸï¼šå¤§å¹…åˆå¹¶åŠ¨ä½œï¼Œä½¿ç”¨ä¸­è¿œæ™¯ï¼Œé•œå¤´å æ¯”æ§åˆ¶åœ¨20%å†…ã€‚
2.çˆ†å‘é«˜æ½®æœŸï¼šæ‰§è¡Œâ€œè§†è§‰åŸå­åŒ–â€ã€‚å‰§æœ¬çš„ä¸€å¥è¯åŠ¨ä½œå¿…é¡»æ‹†è§£ä¸º10ä¸ªä»¥ä¸Šæè‡´ç»†èŠ‚é•œå¤´ï¼ˆèµ·æ‰‹ã€ç ´ç©ºã€æ•Œæ–¹æƒŠæã€æ’å‡»ã€èƒ½é‡ç‚¸è£‚ç­‰ï¼‰ï¼Œå æ€»é•œå¤´æ•°çš„70%ä»¥ä¸Šã€‚
ã€ğŸ”´ çº¢è‰²è­¦æˆ’ï¼šç¦æ­¢äº‹é¡¹ã€‘
ç»å¯¹ç¦æ­¢æ·»åŠ åŸè‘—ä¸­ä¸å­˜åœ¨çš„å‰§æƒ…æƒ…èŠ‚ã€æ–°è§’è‰²æˆ–æ–°å¯¹è¯ã€‚
ä¸¥ç¦æ“…è‡ªè½¬åœº/æ”¶å°¾ï¼šå¦‚æœå‰§æœ¬ç»“æŸæ—¶è§’è‰²è¿˜åœ¨åŸåœ°ï¼Œç»å¯¹ä¸èƒ½ç”Ÿæˆâ€œç¦»å¼€â€çš„é•œå¤´ã€‚
çŸ¥è¯†åº“å°±æ˜¯æ³•å¾‹ï¼šå¿…é¡»å‚è€ƒã€åŸè‘—çŸ¥è¯†åº“ã€‘ä¸­çš„ä¸Šä¸‹æ–‡ã€‚
è¯­è¨€é™åˆ¶ï¼šæ‰€æœ‰å…¶ä»–å­—æ®µå¿…é¡»ä¸¥æ ¼ä½¿ç”¨ä¸­æ–‡ã€‚
viduPrompt ä¸¥ç¦å°†äººç‰©å°è¯åŠ å…¥åˆ°viduPrompté‡Œ
ã€Vidu æç¤ºè¯è§„èŒƒã€‘
ç»“æ„ï¼š\`[2DåŠ¨æ¼«é£æ ¼][åœºæ™¯][æ™¯åˆ«+è¿é•œ] ç”»é¢æè¿°\`ã€‚
è§’è‰²åæ¸…æ´—ï¼šä¸¥ç¦ä½¿ç”¨ \`[èµµé˜”]\` è¿™ç§ç‹¬ç«‹æ ‡ç­¾ã€‚è§’è‰²åå¿…é¡»ä½œä¸ºä¸»è¯­èå…¥æè¿°ã€‚
è§†è§‰é”šå®šï¼šä¸¥æ ¼éµå®ˆçŸ¥è¯†åº“å¤–è²Œæå†™ã€‚
âœ… èŒƒä¾‹ï¼š
-2DåŠ¨æ¼«é£æ ¼ï¼Œæš—å¤œæ£®æ—è°·å£ï¼Œè¿‘æ™¯ï¼Œå›ºå®šé•œå¤´ã€‚ä¸€æšé«˜é€Ÿé£æ¥çš„è››ä¸çƒä»ç”»é¢å‰æ–¹å è½ï¼Œæ­£é¢æ’å‡»åœ°é¢ã€‚æ’å‡»ç¬é—´ï¼Œè››ä¸çƒæœ¬ä½“å‘ç”Ÿæ˜æ˜¾è§£ä½“ï¼ŒçƒçŠ¶ç»“æ„è¿…é€Ÿå´©æ•£æ¶ˆå¤±ï¼ŒåŒ–ä¸ºå¤§é‡å‘å¤–æ‰©å¼ çš„è››ä¸ã€‚è››ä¸åœ¨åœ°é¢é“ºå±•æˆä¸€å¼ æ‰å¹³çš„å¤§å‹è››ç½‘ï¼Œç´§å¯†è´´é™„åœ¨åœ°è¡¨ï¼Œç½‘ä¸æ‹‰ç´§å¹¶å›ºå®šï¼Œå‘ˆç°å‡ºæ˜æ˜¾çš„é»é™„ä¸æŸç¼šçŠ¶æ€ã€‚
ç©ºé—´é€»è¾‘ï¼šå¿…é¡»æè¿°æ”»å‡»ç‰©çš„è¿åŠ¨çŸ¢é‡ï¼ˆä¾‹å¦‚ï¼šç”±ç”»é¢å·¦ä¸‹è§’å°„å‘å³ä¸Šæ–¹ï¼Œæˆ–ç”±ç”»å¤–ä¸­å¿ƒç‚¹é€¼è¿‘ï¼‰ã€‚
è¯·è¿”å›ç¬¦åˆä»¥ä¸‹æ ¼å¼çš„ JSON æ•°ç»„ï¼ˆArray of Objectsï¼‰ï¼Œå­—æ®µåŒ…å«ï¼šshotNumber(int), duration(string), shotType(string), movement(string), visualDescription(string), dialogue(string), emotion(string), viduPrompt(string)ã€‚
ç¡®ä¿æ•°ç»„é•¿åº¦åœ¨ 50-60 ä¹‹é—´ã€‚
`;

// âœ… MODï¼ˆæ–°å¢ï¼‰ï¼šé•œå¤´é¢„ç®—è®¡åˆ’ï¼ˆä¸æ”¹ä½ åŸæç¤ºè¯ï¼Œåªé¢å¤–è¿½åŠ â€œæµç¨‹ç¡¬çº¦æŸâ€ï¼‰
const BUDGET_PLAN_INSTRUCTION = `
ã€é•œå¤´é¢„ç®—å¼ºåˆ¶æµç¨‹ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰ã€‘
åœ¨ç”Ÿæˆåˆ†é•œ shots å‰ï¼Œä½ å¿…é¡»å…ˆç”Ÿæˆ planï¼ˆé•œå¤´é¢„ç®—è¡¨ï¼‰ï¼Œç„¶åä¸¥æ ¼æŒ‰ plan å†ç”Ÿæˆ shotsã€‚
1ï¼‰å°†â€œæœ¬é›†å‰§æœ¬â€åˆ‡åˆ†ä¸º 3â€“8 ä¸ª Beatï¼ˆæ®µè½ï¼‰ã€‚æ¯ä¸ª Beat å¿…é¡»æä¾›ï¼š
- beatId: æ•°å­—
- priority: 1~5ï¼ˆé‡ç‚¹ç­‰çº§ï¼Œåªèƒ½ä¾æ®æœ¬é›†å‰§æœ¬ä¸­â€œå¯è§å˜åŒ–å¼ºåº¦â€åˆ¤å®šï¼‰
- evidence: ä»…å¼•ç”¨æœ¬é›†å‰§æœ¬ä¸­çš„1â€“2å¥åŸæ–‡ä½œä¸ºè¯æ®ï¼ˆçŸ­å¥å³å¯ï¼‰
- beatText: è¯¥ Beat çš„å‰§æœ¬æ–‡æœ¬ï¼ˆç”¨äºåç»­ç”Ÿæˆï¼Œå¿…é¡»æ¥è‡ªæœ¬é›†å‰§æœ¬åŸæ–‡ç‰‡æ®µæ‹¼æ¥ï¼‰
2ï¼‰priority åˆ¤å®šæ ‡å‡†ï¼ˆåªèƒ½æŒ‰æœ¬é›†å‰§æœ¬è¯æ®åˆ¤å®šï¼‰ï¼š
- 1ï¼šçº¯è¿‡åœº/ä¿¡æ¯äº¤ä»£/æ— å±€åŠ¿å˜åŒ–
- 2ï¼šè½»å¾®æ¨è¿›/ç®€å•äº’åŠ¨
- 3ï¼šç´§å¼ è“„åŠ›/å¨èƒå‡çº§ä½†æœªç»“ç®—
- 4ï¼šå…³é”®åŠ¨ä½œé“¾æ¡/ä¸»è§’å‹åˆ¶æˆ–å¼ºåŠ¿ååˆ¶/å±€åŠ¿æ˜æ˜¾æ”¹å˜
- 5ï¼šä¸»è§’é«˜å…‰çˆ†å‘/èƒœè´Ÿæˆ–èº«ä»½ç­‰å…³é”®ç»“ç®—/å¼ºçˆ½ç‚¹è½åœ°
3ï¼‰ä½ å¿…é¡»è‡ªè¡Œå†³å®šæ¯ä¸ª Beat çš„é•œå¤´æ•° shotsï¼Œå¹¶æ»¡è¶³ç¡¬çº¦æŸï¼š
- priority=5 çš„ Beat é•œå¤´æ•° â‰¥ priority=1 çš„ Beat çš„ 3 å€
- é•œå¤´æœ€å¤šçš„ Beat å¿…é¡»å±äº priority 4 æˆ– 5
- priority=1~2 çš„ Beat æ¯æ®µæœ€å¤š 2â€“4 é•œï¼ˆé™¤éè¯¥æ®µåŒ…å«æ˜ç¡®åŠ¨ä½œé“¾æ¡ï¼‰
- æ€»é•œå¤´æ•°æœ€ç»ˆå¿…é¡»åœ¨ 50â€“60
4ï¼‰è¾“å‡ºç»“æ„å¿…é¡»æ˜¯çº¯ JSONï¼š{"plan": {...}} æˆ– {"plan": {...}, "shots": [...] }ã€‚
`;

// âœ… MODï¼ˆæ–°å¢ï¼‰ï¼šKB é™é•¿ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡æ’‘çˆ†å¯¼è‡´æ¨¡å‹ç©ºè¿”å›/æˆªæ–­
function clampText(text: string, maxChars: number): string {
  if (!text) return "";
  return text.length > maxChars ? text.slice(0, maxChars) + "\nï¼ˆä»¥ä¸Šå†…å®¹å·²æˆªæ–­ï¼‰" : text;
}

// âœ… MODï¼ˆæ–°å¢ï¼‰ï¼šJSON å®¹é”™è§£æï¼ˆç©º/æˆªæ–­æ—¶ä¸ä¼šæŠŠæµç¨‹æ‰“çˆ†ï¼‰
function safeJsonParse(raw: string): any | null {
  const txt = (raw || "").replace(/```/g, "").trim();
  if (!txt) return null;

  try {
    return JSON.parse(txt);
  } catch {
    const m = txt.match(/\{[\s\S]*\}/);
    if (!m) return null;
    try {
      return JSON.parse(m[0]);
    } catch {
      return null;
    }
  }
}

// âœ… MODï¼ˆæ–°å¢ï¼‰ï¼šä»æœ¬é›†å‰§æœ¬ä¸­æŠ½å–â€œå…è®¸å‡ºç°çš„äººåé›†åˆâ€ï¼ˆç”¨äºè¶Šç•Œæ£€æµ‹ï¼‰
function extractAllowedNamesFromScript(scriptPart: string): Set<string> {
  const names = new Set<string>();
  const lines = scriptPart.split(/\r?\n/);
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed) continue;

    const m = trimmed.match(/^([\u4e00-\u9fa5]{1,8})(?=ï¼ˆ|:|ï¼š)/);
    if (m?.[1]) names.add(m[1]);

    const m2 = trimmed.match(/^(äººç‰©|è§’è‰²)\s*[:ï¼š]\s*([\u4e00-\u9fa5ã€ï¼Œ,\s]{2,})/);
    if (m2?.[2]) {
      const parts = m2[2].split(/[ã€ï¼Œ,\s]+/).map(s => s.trim()).filter(Boolean);
      for (const p of parts) {
        if (/^[\u4e00-\u9fa5]{1,8}$/.test(p)) names.add(p);
      }
    }
  }
  return names;
}

// âœ… MODï¼ˆæ–°å¢ï¼‰ï¼šæ£€æµ‹æ˜¯å¦å«æœ‰â€œä¸²é›†/å‰æƒ…/é›†æ•°è·³è½¬â€ç­‰æ˜æ˜¾è¶Šç•Œæ ‡è®°
function hasCrossEpisodeMarkers(text: string): boolean {
  const markers = [
    /ç¬¬\s*\d+\s*é›†/,
    /ä¸Šä¸€é›†|ä¸‹é›†|å‰æƒ…|å›é¡¾/,
    /å¤šå¹´å|åæ¥|ä¸æ­¤åŒæ—¶|å¦ä¸€è¾¹/,
    /ä¸Šå›è¯´åˆ°|æœªå®Œå¾…ç»­/
  ];
  return markers.some(r => r.test(text));
}

// âœ… MODï¼ˆæ–°å¢ï¼‰ï¼šåˆ¤æ–­æŸä¸€é•œæ˜¯å¦å‡ºç°â€œæœ¬é›†æœªå‡ºç°çš„äººåâ€ï¼ˆä»…å½“ allowedNames éç©ºæ—¶å¯ç”¨ï¼‰
function findOutOfScopeNames(text: string, allowedNames: Set<string>): string[] {
  if (!allowedNames || allowedNames.size === 0) return [];

  const candidates = new Set<string>();
  const re = /[\u4e00-\u9fa5]{2,8}/g;
  let m: RegExpExecArray | null;

  while ((m = re.exec(text)) !== null) {
    const token = m[0];
    if (/^(é•œå¤´|ç”»é¢|ç‰¹å†™|è¿‘æ™¯|ä¸­æ™¯|è¿œæ™¯|å›ºå®šé•œå¤´|æ¨é•œ|æ‹‰é•œ|æ‘‡é•œ|è·Ÿæ‹|å®¤å†…|å®¤å¤–|å¤œ|æ—¥|å†…|å¤–|é›·ç”µ|é£|å°˜åœŸ|ç¢çŸ³|ç©ºæ°”)$/.test(token)) {
      continue;
    }
    if (/^(ç‹çˆ·|ç®¡å®¶|äº²å…µ|ä¾å«|ä¸«é¬Ÿ|é“é•¿|å°†å†›|å¤§äºº|å…¬å­|å°å§|å¤«äºº|äºŒå°å§)$/.test(token)) {
      continue;
    }
    candidates.add(token);
  }

  const out: string[] = [];
  for (const c of candidates) {
    if (allowedNames.has(c)) continue;
    let containsKnown = false;
    for (const a of allowedNames) {
      if (c.includes(a) || a.includes(c)) {
        containsKnown = true;
        break;
      }
    }
    if (!containsKnown) out.push(c);
  }
  return out;
}

type BeatPlan = {
  beatId: number;
  priority: number;      // 1-5
  evidence: string;      // 1-2å¥åŸæ–‡
  beatText: string;      // è¯¥æ®µå‰§æœ¬æ–‡æœ¬
  shots: number;         // è¯¥æ®µé•œå¤´æ•°
};

type StoryboardPlan = {
  totalShots: number;
  beats: BeatPlan[];
};

// âœ… MODï¼šç”Ÿæˆâ€œé•œå¤´é¢„ç®— planâ€
async function fetchStoryboardPlan(scriptPart: string, kbContext: string): Promise<StoryboardPlan | null> {
  const response = await openai.chat.completions.create({
    model: "google/gemini-3-pro-preview",
    messages: [
      { role: "system", content: STORYBOARD_PROMPT },
      { role: "system", content: `ã€å‚è€ƒè®¾å®šèµ„æ–™ï¼ˆåªç”¨äºå¤–è²Œ/è§†è§‰ä¸€è‡´æ€§ï¼Œä¸¥ç¦å½“ä½œå‰§æƒ…æ¥æºï¼‰ã€‘\n${kbContext}` },
      {
        role: "user",
        content: `${BUDGET_PLAN_INSTRUCTION}\n\nã€æœ¬é›†å‰§æœ¬ï¼ˆå”¯ä¸€å‰§æƒ…çœŸç†ï¼‰ã€‘\n${scriptPart}\n\nã€è¾“å‡ºè¦æ±‚ã€‘è¯·åªè¿”å›çº¯ JSONï¼š{"plan":{"totalShots":xx,"beats":[{"beatId":1,"priority":5,"evidence":"...","beatText":"...","shots":18},...]}}`
      }
    ],
    response_format: { type: "json_object" }
  });

  const rawText = response.choices?.[0]?.message?.content || "";
  const cleanJson = rawText.replace(/json/g, "").replace(/```/g, "").trim();

  const parsed = safeJsonParse(cleanJson);
  if (!parsed) return null;

  const plan = parsed.plan || parsed.p;
  if (!plan || !Array.isArray(plan.beats)) return null;

  const beats: BeatPlan[] = plan.beats
    .map((b: any, idx: number) => ({
      beatId: Number.isFinite(b.beatId) ? b.beatId : (idx + 1),
      priority: Number.isFinite(b.priority) ? b.priority : 3,
      evidence: typeof b.evidence === "string" ? b.evidence : "",
      beatText: typeof b.beatText === "string" ? b.beatText : "",
      shots: Number.isFinite(b.shots) ? b.shots : 6
    }))
    .filter((b: BeatPlan) => b.beatText.trim().length > 0);

  const totalShots = Number.isFinite(plan.totalShots)
    ? plan.totalShots
    : beats.reduce((sum: number, b: BeatPlan) => sum + (b.shots || 0), 0);

  if (beats.length === 0) return null;
  return { totalShots, beats };
}

async function fetchShotsBatch(scriptPart: string, kbContext: string, range: string, startNo: number, count: number) {
  const response = await openai.chat.completions.create({
    model: "google/gemini-3-pro-preview",
    messages: [
      { role: "system", content: STORYBOARD_PROMPT },
      { role: "system", content: `ã€å‚è€ƒè®¾å®šèµ„æ–™ï¼ˆåªç”¨äºå¤–è²Œ/è§†è§‰ä¸€è‡´æ€§ï¼Œä¸¥ç¦å½“ä½œå‰§æƒ…æ¥æºï¼‰ã€‘\n${kbContext}` },
      {
        role: "user",
        content: `ã€æœ¬é›†å‰§æœ¬ï¼ˆå½“å‰å”¯ä¸€å¿…é¡»æ‰§è¡Œçš„å‰§æƒ…ç°å®ï¼‰ã€‘ï¼š\n${scriptPart}\n\nã€ç”ŸæˆæŒ‡ä»¤ã€‘ï¼šè¯†åˆ«å‰§æœ¬ä¸­çš„é«˜æ½®é«˜å…‰æ—¶åˆ»ï¼Œå°†æ›´å¤šçš„åˆ†é•œé¢åº¦å€¾æ³¨åœ¨æ­¤ï¼Œè¿›è¡ŒåŠ¨ä½œåŸå­åŒ–æ‹†è§£ï¼›å…¶ä½™å¹³æ·¡éƒ¨åˆ†è¯·å¤§å¹…å‹ç¼©åˆå¹¶ã€‚ä¸€æ¬¡æ€§ç”ŸæˆèŒƒå›´ ${range}ï¼Œç›®æ ‡çº¦ ${count} é•œã€‚è¯·ä¸¥æ ¼è¿”å›çº¯ JSON æ ¼å¼ï¼š{"shots": [...]}`
      }
    ],
    response_format: { type: "json_object" }
  });

  const rawText = response.choices?.[0]?.message?.content || "";
  const cleanJson = rawText.replace(/json/g, "").replace(/```/g, "").trim();

  const parsed = safeJsonParse(cleanJson);
  if (parsed) {
    return parsed.shots || parsed.s || (Array.isArray(parsed) ? parsed : []);
  }

  const matches = cleanJson.match(/{"shotNumber":[\s\S]*?}/g);
  return matches ? matches.map(m => {
    try { return JSON.parse(m.endsWith('}') ? m : m + '}'); } catch { return null; }
  }).filter(Boolean) : [];
}

function injectActionCarryover(currentShot: any, prevShot?: any): Shot {
  if (!prevShot) return currentShot;
  const isOngoing = prevShot.actionState === "start" || prevShot.actionState === "ongoing";
  const coreAction = prevShot.visualDescription?.slice(0, 30) || "ä¸Šä¸€é•œå¤´åŠ¨ä½œ";
  return {
    shotNumber: currentShot.shotNumber || 0,
    duration: currentShot.duration || "3s",
    shotType: currentShot.shotType || "ä¸­æ™¯",
    movement: currentShot.movement || "å›ºå®šé•œå¤´",
    visualDescription: isOngoing
      ? `ã€åŠ¨ä½œç»§æ‰¿ã€‘æ‰¿æ¥ä¸Šä¸€é•œæœªå®ŒæˆåŠ¨ä½œï¼š${coreAction}ã€‚\n${currentShot.visualDescription}`
      : currentShot.visualDescription,
    dialogue: currentShot.dialogue || "",
    emotion: currentShot.emotion || "",
    viduPrompt: isOngoing
      ? `ã€æœªå®ŒæˆåŠ¨ä½œç»§æ‰¿ã€‘ä¸Šä¸€é•œåŠ¨ä½œç»§ç»­ï¼š${currentShot.viduPrompt}`
      : currentShot.viduPrompt,
    actionState: currentShot.actionState
  };
}

export type ScriptStyle = 'æƒ…ç»ªæµ' | 'éæƒ…ç»ªæµ';

export async function generateStoryboard(
  episode: Episode,
  kb: KBFile[],
  batchIndex: number = 0,
  previousShots: Shot[] = [],
  style: ScriptStyle = 'æƒ…ç»ªæµ'
): Promise<Shot[]> {
  if (batchIndex > 0) return [];

  const dynamicPrompt = `${STORYBOARD_PROMPT}\n\n${STYLE_PROMPTS[style]}`;

  // âœ… MODï¼šKB é™é•¿ï¼ˆå…³é”®ä¿®å¤ï¼šé¿å…ä¸Šä¸‹æ–‡æ’‘çˆ†å¯¼è‡´æ¨¡å‹ç©º/æˆªæ–­ JSONï¼‰
  const kbContext = kb.length > 0
    ? clampText(
        kb.map(f => `ã€å‚è€ƒè®¾å®šèµ„æ–™ï¼š${f.name}ã€‘\n${clampText(f.content, 6000)}`).join('\n'),
        16000
      )
    : "ï¼ˆæš‚æ— ç‰¹å®šçŸ¥è¯†åº“ï¼‰";

  try {
    const script = episode.script;
    console.log(`ğŸš€ æ­£åœ¨å‘èµ·å…¨é‡åŠ æƒç”Ÿæˆ (ç›®æ ‡ 50-60 é•œï¼Œéš”ç¦»æ¨¡å¼ + é•œå¤´é¢„ç®— plan)...`);

    // âœ… MODï¼šå…ˆæ‹¿ plan
    const plan = await fetchStoryboardPlan(script, kbContext);

    // plan å¤±è´¥å…œåº•ï¼šå›é€€ä¸€æ¬¡æ€§ 60 é•œ
    let newRawShots: any[] = [];
    if (!plan) {
      console.warn("âš ï¸ é¢„ç®— plan ç”Ÿæˆå¤±è´¥ï¼Œå·²å›é€€åˆ°ä¸€æ¬¡æ€§ç”Ÿæˆ 60 é•œ");
      newRawShots = await fetchShotsBatch(
        script,
        kbContext,
        "1-60",
        1,
        60
      );
    } else {
      let cursor = 1;
      for (const beat of plan.beats) {
        const count = Math.max(1, Math.min(beat.shots || 1, 60));
        const range = `${cursor}-${cursor + count - 1}`;

        const beatShots = await fetchShotsBatch(
          beat.beatText,
          kbContext,
          range,
          cursor,
          count
        );

        newRawShots.push(...(Array.isArray(beatShots) ? beatShots : []));
        cursor += count;
      }

      if (newRawShots.length > 60) newRawShots = newRawShots.slice(0, 60);
      if (newRawShots.length < 50) {
        const need = 50 - newRawShots.length;
        const tailText = plan.beats[plan.beats.length - 1]?.beatText || script;
        const extra = await fetchShotsBatch(
          tailText,
          kbContext,
          `${newRawShots.length + 1}-${newRawShots.length + need}`,
          newRawShots.length + 1,
          need
        );
        newRawShots.push(...(Array.isArray(extra) ? extra : []));
        if (newRawShots.length > 60) newRawShots = newRawShots.slice(0, 60);
      }
    }

    // âœ… MODï¼šç»Ÿä¸€é‡ç¼–å·ï¼Œé¿å…åˆ†æ®µç”Ÿæˆå¯¼è‡´ shotNumber æ··ä¹±
    newRawShots = (newRawShots || []).map((s: any, idx: number) => ({
      ...s,
      shotNumber: idx + 1
    }));

    const processedNewShots = newRawShots.map((shot: any, index: number) => {
      const prev = newRawShots[index - 1];
      return injectActionCarryover(shot, prev);
    });

    // âœ… MODï¼šè¶Šç•Œæ£€æµ‹ + è‡ªåŠ¨â€œå•é•œé‡ç”Ÿâ€å…œåº•ï¼ˆé˜²ä¸²é›†ï¼‰
    const allowedNames = extractAllowedNamesFromScript(script);
    const fixedShots: Shot[] = [...processedNewShots];

    const MAX_FIXES = 12;
    let fixes = 0;

    for (let i = 0; i < fixedShots.length; i++) {
      if (fixes >= MAX_FIXES) break;

      const s = fixedShots[i];
      const blob = `${s.visualDescription || ""}\n${s.dialogue || ""}\n${s.viduPrompt || ""}`;

      const crossEpisode = hasCrossEpisodeMarkers(blob);
      const outNames = findOutOfScopeNames(blob, allowedNames);

      const shouldFix = crossEpisode || outNames.length >= 2;
      if (!shouldFix) continue;

      try {
        const prevShot = i > 0 ? fixedShots[i - 1] : undefined;
        const regenerated = await regenerateSingleShot(
          episode,
          kb,
          s,
          prevShot
        );
        fixedShots[i] = regenerated;
        fixes += 1;
      } catch (e) {
        console.warn(`âš ï¸ å•é•œé‡ç”Ÿå¤±è´¥ï¼ˆç¬¬ ${s.shotNumber} é•œï¼‰ï¼Œå·²è·³è¿‡`, e);
      }
    }

    // âœ… MODï¼šä¿®å¤åå†æ¬¡ç¡®ä¿ç¼–å·è¿ç»­
    return fixedShots.map((s, idx) => ({ ...s, shotNumber: idx + 1 }));
  } catch (err) {
    console.error(`åˆ†é•œç”Ÿæˆå¤±è´¥:`, err);
    throw err;
  }
}

export async function regenerateSingleShot(
  episode: Episode,
  kb: KBFile[],
  shotToRegenerate: Shot,
  previousShot?: Shot
): Promise<Shot> {
  // âœ… MODï¼šåŒæ ·å¯¹å•é•œé‡ç”Ÿçš„ KB åšé™é•¿ï¼Œé¿å…æˆªæ–­/ç©ºè¿”å›
  const kbContext = kb.length > 0
    ? clampText(
        kb.map(f => `ã€è§†è§‰å­—å…¸/è®¾å®šå‚è€ƒã€‘ï¼š\n${clampText(f.content, 6000)}`).join('\n'),
        16000
      )
    : "ï¼ˆæš‚æ— ç‰¹å®šçŸ¥è¯†åº“ï¼‰";

  const userPrompt = `
é‡æ–°è®¾è®¡ç¬¬ ${shotToRegenerate.shotNumber} é•œã€‚è¦æ±‚ç”»é¢ç»†èŠ‚æ›´ä¸°å¯Œï¼Œä¸¥æ ¼éµå®ˆå‰§æœ¬é€»è¾‘ï¼Œä¿æŒä¸ä¸Šæ–‡è¿è´¯ã€‚
ã€ä¸Šæ–‡å‚è€ƒã€‘ï¼š${previousShot ? previousShot.visualDescription : "æ— "}
ã€åŸåˆ†é•œå†…å®¹ã€‘ï¼š${shotToRegenerate.visualDescription}
ã€å½“å‰å‰§æœ¬ç‰‡æ®µï¼ˆå”¯ä¸€å‰§æƒ…çœŸç†ï¼‰ã€‘ï¼š${episode.script.slice(0, 1000)}...
`;

  const response = await openai.chat.completions.create({
    model: "google/gemini-3-pro-preview",
    messages: [
      { role: "system", content: STORYBOARD_PROMPT },
      { role: "system", content: `ã€å‚è€ƒè®¾å®šèµ„æ–™ï¼ˆåªç”¨äºå¤–è²Œ/è§†è§‰ä¸€è‡´æ€§ï¼Œä¸¥ç¦å½“ä½œå‰§æƒ…æ¥æºï¼‰ã€‘\n${kbContext}` },
      { role: "user", content: userPrompt }
    ],
    response_format: { type: "json_object" }
  });

  const rawText = response.choices?.[0]?.message?.content || "";
  const cleanJson = rawText.replace(/json/g, "").replace(/```/g, "").trim();

  const parsed = safeJsonParse(cleanJson);
  if (!parsed) {
    console.error("è§£æå•é•œå¤´ JSON å¤±è´¥ï¼šæ¨¡å‹è¿”å›ä¸ºç©ºæˆ–è¢«æˆªæ–­");
    return shotToRegenerate;
  }

  const newShotData = parsed.shot || (Array.isArray(parsed.shots) ? parsed.shots[0] : parsed);
  return injectActionCarryover(newShotData, previousShot);
}
